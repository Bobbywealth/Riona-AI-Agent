<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instagram Bot Dashboard</title>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --dark: #1f2937;
            --light: #f9fafb;
            --border: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--dark);
        }
        
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px;
        }
        
        /* Compact Header with Status */
        .header {
            background: white;
            border-radius: 16px;
            padding: 15px 25px;
            margin-bottom: 15px;
            box-shadow: var(--shadow-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .header h1 {
            font-size: 1.5em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-indicators {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .status-pill {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            background: var(--light);
            border: 1px solid var(--border);
        }
        
        .status-pill.online { background: #d1fae5; border-color: var(--success); color: #065f46; }
        .status-pill.offline { background: #fee2e2; border-color: var(--danger); color: #991b1b; }
        .status-pill.warning { background: #fef3c7; border-color: var(--warning); color: #92400e; }
        
        .pulse {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        
        /* Tab Navigation */
        .tab-nav {
            background: white;
            border-radius: 16px;
            padding: 8px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
            display: flex;
            gap: 8px;
            overflow-x: auto;
        }
        
        .tab-btn {
            flex: 1;
            min-width: 100px;
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            background: transparent;
            color: #6b7280;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            white-space: nowrap;
        }
        
        .tab-btn:hover {
            background: var(--light);
            color: var(--dark);
        }
        
        .tab-btn.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Cards */
        .card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }
        
        .card-icon {
            font-size: 20px;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
        }
        
        .card h2 {
            font-size: 1.1em;
            color: var(--dark);
            flex: 1;
        }
        
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        
        /* Form Elements */
        .form-group {
            margin-bottom: 12px;
        }
        
        .form-row {
            display: flex;
            gap: 12px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--dark);
            font-size: 13px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
            font-family: inherit;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        /* Buttons */
        button {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        button:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            width: 100%;
        }
        
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-info { background: var(--info); color: white; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-sm { padding: 8px 12px; font-size: 13px; }
        .btn-full { width: 100%; margin-top: 10px; }
        
        /* Checkbox */
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: var(--light);
            border-radius: 8px;
            cursor: pointer;
            margin: 8px 0;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: auto;
            cursor: pointer;
        }
        
        .checkbox-group label {
            margin: 0;
            font-weight: 500;
        }
        
        .status-message.success {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-message.error {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .status-message.info {
            background: #dbeafe;
            color: #1e40af;
        }
        
        /* Loading Spinner */
        .loading {
            display: none;
            text-align: center;
            padding: 15px;
            color: var(--primary);
            font-weight: 600;
        }
        
        .loading.active {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid var(--light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Logs */
        .log-container {
            background: var(--dark);
            color: #d1d5db;
            padding: 20px;
            border-radius: 10px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
        }

        .ai-chat-log {
            background: #0f172a;
            color: #e5e7eb;
            border-radius: 12px;
            padding: 14px;
            height: 260px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
            border: 1px solid #1f2937;
        }

        .ai-chat-bubble {
            padding: 10px 12px;
            border-radius: 10px;
            line-height: 1.4;
            font-size: 0.95rem;
            box-shadow: 0 6px 18px rgba(15, 23, 42, 0.25);
        }

        .ai-chat-bubble.user {
            background: #eef2ff;
            color: #1f2937;
            align-self: flex-end;
        }

        .ai-chat-bubble.assistant {
            background: #111827;
            color: #e5e7eb;
            border: 1px solid #1f2937;
        }

        .ai-chat-input {
            display: flex;
            gap: 12px;
            margin-top: 14px;
        }

        .ai-chat-input input {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid #d1d5db;
            font-size: 0.95rem;
        }

        .ai-log-snippet {
            margin-top: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.06);
            border-radius: 8px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.8rem;
            color: #cbd5f5;
        }
        
        .log-entry {
            padding: 8px 12px;
            margin-bottom: 4px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.05);
            border-left: 3px solid #6b7280;
        }
        
        .log-entry.log-success {
            color: #10b981;
            border-left-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }
        
        .log-entry.log-error {
            color: #ef4444;
            border-left-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }
        
        .log-entry.log-warning {
            color: #f59e0b;
            border-left-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }
        
        .log-entry.log-info {
            color: #3b82f6;
            border-left-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }
        
        .log-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .log-container::-webkit-scrollbar-track {
            background: #374151;
            border-radius: 10px;
        }
        
        .log-container::-webkit-scrollbar-thumb {
            background: #6b7280;
            border-radius: 10px;
        }
        
        /* Collapsible Sections */
        .collapsible {
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: var(--light);
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 600;
            font-size: 13px;
        }
        
        .collapsible-header:hover { background: #e5e7eb; }
        
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .collapsible-content.active {
            max-height: 500px;
        }
        
        .arrow {
            transition: transform 0.3s;
            font-size: 12px;
        }
        
        .arrow.active { transform: rotate(180deg); }
        
        /* Status Messages */
        .status-message {
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
        }
        
        .status-message.success { background: #d1fae5; color: #065f46; }
        .status-message.error { background: #fee2e2; color: #991b1b; }
        .status-message.info { background: #dbeafe; color: #1e40af; }
        
        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 12px;
            color: var(--primary);
            font-weight: 600;
            font-size: 13px;
        }
        
        .loading.active {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Log Stats Bar */
        .log-stats {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        
        .stat-item {
            flex: 1;
            min-width: 70px;
            padding: 10px 12px;
            background: var(--light);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        .stat-item:hover { background: #e5e7eb; }
        .stat-item.active { border-color: var(--primary); }
        .stat-item.stat-info { border-left: 3px solid var(--info); }
        .stat-item.stat-warn { border-left: 3px solid var(--warning); }
        .stat-item.stat-error { border-left: 3px solid var(--danger); }
        
        .stat-count {
            display: block;
            font-size: 1.4em;
            font-weight: 700;
            color: var(--dark);
        }
        
        .stat-label {
            font-size: 11px;
            color: #6b7280;
            text-transform: uppercase;
        }
        
        /* Log Filters */
        .log-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            gap: 8px;
            flex: 1;
        }
        
        .filter-group select, .filter-group input {
            flex: 1;
            min-width: 100px;
            padding: 8px 10px;
            font-size: 12px;
        }
        
        /* Log Actions */
        .log-actions {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .log-actions button {
            flex: 0;
            min-width: auto;
            padding: 6px 10px;
            font-size: 12px;
        }
        
        /* Logs Container */
        .log-container {
            background: #1a1a2e;
            color: #d1d5db;
            padding: 12px;
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            font-size: 11px;
            line-height: 1.4;
        }
        
        .log-entry {
            padding: 8px 10px;
            margin-bottom: 4px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.03);
            border-left: 3px solid #4b5563;
            display: flex;
            align-items: flex-start;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .log-entry:hover { background: rgba(255, 255, 255, 0.06); }
        
        .log-entry.log-info { border-left-color: #3b82f6; }
        .log-entry.log-warn { border-left-color: #f59e0b; background: rgba(245, 158, 11, 0.08); }
        .log-entry.log-error { border-left-color: #ef4444; background: rgba(239, 68, 68, 0.1); }
        .log-entry.log-debug { border-left-color: #8b5cf6; }
        .log-entry.log-success { border-left-color: #10b981; }
        
        .log-time {
            color: #6b7280;
            font-size: 10px;
            min-width: 65px;
            flex-shrink: 0;
        }
        
        .log-badge {
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            text-transform: uppercase;
            flex-shrink: 0;
        }
        
        .badge-login { background: #818cf8; color: white; }
        .badge-campaign { background: #f472b6; color: white; }
        .badge-story { background: #34d399; color: white; }
        .badge-dm { background: #60a5fa; color: white; }
        .badge-browser { background: #a78bfa; color: white; }
        .badge-proxy { background: #fbbf24; color: #1f2937; }
        .badge-scheduler { background: #fb923c; color: white; }
        .badge-screenshot { background: #2dd4bf; color: white; }
        .badge-system { background: #6b7280; color: white; }
        
        .log-message {
            flex: 1;
            word-break: break-word;
            color: #e5e7eb;
        }
        
        .log-entry.log-error .log-message { color: #fca5a5; }
        .log-entry.log-warn .log-message { color: #fcd34d; }
        
        /* Quick Actions Bar */
        .quick-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        
        .quick-actions button {
            flex: 1;
            min-width: 120px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header { flex-direction: column; text-align: center; }
            .tab-btn { min-width: 80px; padding: 10px 12px; font-size: 12px; }
            .card-grid { grid-template-columns: 1fr; }
            .form-row { flex-direction: column; }
        }
        
        .hidden { display: none !important; }
        .mt-2 { margin-top: 10px; }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Compact Header with Status Indicators -->
        <div class="header">
            <h1><span>ü§ñ</span> Instagram Bot</h1>
            <div class="status-indicators">
                <div id="loginStatus" class="status-pill offline">
                    <div class="pulse"></div>
                    <span>Checking...</span>
                </div>
                
                <!-- Login Form (shown when logged out) -->
                <div id="loginForm">
                    <div class="form-group">
                        <label>Instagram Username</label>
                        <input type="text" id="loginUsername" placeholder="your_username">
                    </div>
                    <div class="form-group">
                        <label>Instagram Password</label>
                        <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="rememberMeCheckbox" checked>
                        <label style="margin: 0;">Remember me for 30 days</label>
                    </div>
                    <button class="btn-success" onclick="login()">üîì Login</button>
                </div>
                
                <!-- Logged In Controls (shown when logged in) -->
                <div id="loggedInControls" class="hidden">
                    <button class="btn-danger" onclick="logout()">üö™ Logout</button>
                    <button class="btn-secondary" onclick="clearCookies()">üßπ Clear Cookies</button>
                </div>
                
                <div class="loading" id="loadingLogin">
                    <div class="spinner"></div>
                    <span>Processing...</span>
                </div>
                <div id="loginStatus" class="status-message info mt-2">
                    ‚ÑπÔ∏è Checking status...
                </div>
            </div>
            
            <!-- Proxy Configuration -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">üåê</div>
                    <h2>Proxy Settings</h2>
                </div>
                <div class="status-message info mb-2">
                    ‚ÑπÔ∏è Using a proxy helps avoid Instagram rate limits and IP blocks
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="proxyEnabled">
                    <label style="margin: 0;">Enable Proxy</label>
                </div>
                <div id="proxyFields" class="hidden">
                    <div class="form-group">
                        <label>Proxy Host</label>
                        <input type="text" id="proxyHost" placeholder="proxy.example.com">
                    </div>
                    <div class="form-group">
                        <label>Proxy Port</label>
                        <input type="number" id="proxyPort" placeholder="8080">
                    </div>
                    <div class="form-group">
                        <label>Proxy Username (optional)</label>
                        <input type="text" id="proxyUsername" placeholder="username">
                    </div>
                    <div class="form-group">
                        <label>Proxy Password (optional)</label>
                        <input type="password" id="proxyPassword" placeholder="password">
                    </div>
                    <button class="btn-primary" onclick="saveProxySettings()">üíæ Save Proxy Settings</button>
                </div>
                <div class="loading hidden" id="loadingProxy">
                    <div class="spinner"></div>
                    <span>Saving...</span>
                </div>
                <div id="proxyStatus" class="status-message info mt-2 hidden">
                    ‚ÑπÔ∏è Proxy status
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">‚ö°</div>
                    <h2>Lead Generation</h2>
                </div>
                <div class="form-group">
                    <label>Targeting Mode</label>
                    <select id="interactionMode" onchange="updateInteractionFields()">
                        <option value="feed">Recent Feed</option>
                        <option value="explore">Explore Page</option>
                        <option value="hashtag">Hashtag Search</option>
                        <option value="location">Location Search</option>
                        <option value="user">Specific User</option>
                        <option value="competitor_followers">Competitor Followers</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Max Posts to Process</label>
                    <input type="number" id="maxPostsInput" value="10" min="1" max="100">
                </div>
                
                <!-- Dynamic Fields -->
                <div id="targetUsernameGroup" class="form-group hidden">
                    <label>Target Username</label>
                    <input type="text" id="interactionTarget" placeholder="username (no @)">
                </div>
                <div id="hashtagGroup" class="form-group hidden">
                    <label>Hashtags (comma separated)</label>
                    <input type="text" id="interactionHashtags" placeholder="restaurant, miami, food">
                </div>
                <div id="locationGroup" class="form-group hidden">
                    <label>Location Path</label>
                    <input type="text" id="locationPath" placeholder="212941492/miami-florida">
                </div>
                <div id="competitorGroup" class="form-group hidden">
                    <label>Competitor Username</label>
                    <input type="text" id="competitorUsername" placeholder="competitor_username">
                </div>
                
                <!-- Advanced Options -->
                <div class="collapsible" onclick="toggleCollapsible('advancedOptions')">
                    <span>‚öôÔ∏è Advanced Filters</span>
                    <span class="arrow" id="advancedOptionsArrow">‚ñº</span>
                </div>
                <div id="advancedOptions" class="collapsible-content">
                    <div class="form-group">
                        <label>Min Likes (optional)</label>
                        <input type="number" id="minLikesInput" placeholder="e.g., 50">
                    </div>
                    <div class="form-group">
                        <label>Min Comments (optional)</label>
                        <input type="number" id="minCommentsInput" placeholder="e.g., 5">
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="englishOnlyCheckbox" checked>
                        <label style="margin: 0;">English captions only</label>
                    </div>
                </div>
                
                <button class="btn-primary" onclick="startCommenting()">üöÄ Start Campaign</button>
                <button class="btn-info" onclick="checkStatus()">üìä Check Status</button>
                <div class="loading" id="loading1">
                    <div class="spinner"></div>
                    <span>Running campaign...</span>
                </div>
            </div>
            
            <!-- Story Viewer -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">üì∫</div>
                    <h2>Story Engagement</h2>
                </div>
                <div class="form-group">
                    <label>Stories to Watch</label>
                    <input type="number" id="storyCount" value="10" min="1" max="50">
                </div>
                <div class="form-group">
                    <label>Target User (optional)</label>
                    <input type="text" id="storyTarget" placeholder="Leave empty for feed">
                </div>
                <div class="flex gap-2">
                    <div class="form-group" style="flex: 1;">
                        <label>Like % (0-100)</label>
                        <input type="number" id="storyLikeProbability" value="30" min="0" max="100">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>React % (0-100)</label>
                        <input type="number" id="storyReactionProbability" value="20" min="0" max="100">
                    </div>
                </div>
                <div class="form-group">
                    <label>Reaction Emoji</label>
                    <input type="text" id="storyReactionEmoji" value="üî•" maxlength="2">
                </div>
                <div class="flex gap-2">
                    <div class="form-group" style="flex: 1;">
                        <label>Min Watch (sec)</label>
                        <input type="number" id="storyMinWatch" value="5" min="2">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Max Watch (sec)</label>
                        <input type="number" id="storyMaxWatch" value="9" min="3">
                    </div>
                </div>
                <div class="card-divider"></div>
                <div class="checkbox-group">
                    <input type="checkbox" id="storyAiReplyEnabled">
                    <label style="margin: 0;">Enable AI story replies (Gemini-powered)</label>
                </div>
                <div id="storyAiOptions" class="hidden">
                    <div class="form-group">
                        <label>Max AI Replies per Session</label>
                        <input type="number" id="storyAiMaxReplies" value="3" min="1" max="20">
                    </div>
                    <div class="form-group">
                        <label>Reply Tone</label>
                        <select id="storyAiTone">
                            <option value="friendly">Friendly + warm</option>
                            <option value="consultative">Consultative / advisor</option>
                            <option value="hype">High-energy / hype</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Confidence Threshold (%)</label>
                        <input type="number" id="storyAiConfidence" value="55" min="10" max="100">
                        <small style="display:block;color:#6b7280;margin-top:4px;">Only reply when Gemini confidence exceeds this level.</small>
                    </div>
                </div>
                <button class="btn-primary" onclick="watchStories()">üëÅÔ∏è Watch Stories</button>
                <div class="loading" id="loadingStories">
                    <div class="spinner"></div>
                    <span>Watching stories...</span>
                </div>
            </div>
        </div>
        
        <!-- Tab Navigation -->
        <div class="tab-nav">
            <button class="tab-btn active" onclick="showTab('setup')">
                <span>‚öôÔ∏è</span> Setup
            </button>
            <button class="tab-btn" onclick="showTab('campaigns')">
                <span>üöÄ</span> Campaigns
            </button>
            <button class="tab-btn" onclick="showTab('automation')">
                <span>ü§ñ</span> Automation
            </button>
            <button class="tab-btn" onclick="showTab('logs')">
                <span>üìã</span> Logs
            </button>
        </div>
        
        <!-- SETUP TAB -->
        <div id="tab-setup" class="tab-content active">
            <div class="card-grid">
                <!-- Account Card -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">üîê</div>
                        <h2>Account</h2>
                    </div>
                    
                    <div id="loginForm">
                        <div class="form-group">
                            <label>Instagram Username</label>
                            <input type="text" id="loginUsername" placeholder="your_username">
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="rememberMeCheckbox" checked>
                            <label>Remember me for 7 days</label>
                        </div>
                        <button class="btn-success btn-full" onclick="login()">üîì Login</button>
                    </div>
                    
                    <div id="loggedInControls" class="hidden">
                        <div class="status-message success">‚úÖ Logged in successfully</div>
                        <button class="btn-danger btn-full" onclick="logout()">üö™ Logout</button>
                        <button class="btn-secondary btn-full" onclick="clearCookies()">üßπ Clear Cookies</button>
                    </div>
                    
                    <div class="loading" id="loadingLogin">
                        <div class="spinner"></div>
                        <span>Connecting...</span>
                    </div>
                </div>
                <button class="btn-primary" onclick="monitorDMs()">üì¨ Monitor & Auto-Reply</button>
                <button class="btn-info" onclick="clearDMCache()">üóëÔ∏è Clear Reply Cache</button>
                <div class="collapsible mt-2" onclick="toggleCollapsible('sendDMSection')">
                    <span>üì© Send Manual DM</span>
                    <span class="arrow" id="sendDMSectionArrow">‚ñº</span>
                </div>
            </div>
        </div>
        
        <!-- CAMPAIGNS TAB -->
        <div id="tab-campaigns" class="tab-content">
            <div class="card-grid">
                <!-- Lead Generation -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">‚ö°</div>
                        <h2>Lead Generation</h2>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Targeting Mode</label>
                            <select id="interactionMode" onchange="updateInteractionFields()">
                                <option value="feed">Recent Feed</option>
                                <option value="explore">Explore Page</option>
                                <option value="hashtag">Hashtag Search</option>
                                <option value="location">Location Search</option>
                                <option value="user">Specific User</option>
                                <option value="competitor_followers">Competitor Followers</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Max Posts</label>
                            <input type="number" id="maxPostsInput" value="10" min="1" max="100">
                        </div>
                    </div>
                    
                    <div id="targetUsernameGroup" class="form-group hidden">
                        <label>Target Username</label>
                        <input type="text" id="interactionTarget" placeholder="username (no @)">
                    </div>
                    <div id="hashtagGroup" class="form-group hidden">
                        <label>Hashtags (comma separated)</label>
                        <input type="text" id="interactionHashtags" placeholder="restaurant, miami, food">
                    </div>
                    <div id="locationGroup" class="form-group hidden">
                        <label>Location Path</label>
                        <input type="text" id="locationPath" placeholder="212941492/miami-florida">
                    </div>
                    <div id="competitorGroup" class="form-group hidden">
                        <label>Competitor Username</label>
                        <input type="text" id="competitorUsername" placeholder="competitor_username">
                    </div>
                    
                    <div class="collapsible-header" onclick="toggleCollapsible('advancedOptions')">
                        <span>‚öôÔ∏è Advanced Filters</span>
                        <span class="arrow" id="advancedOptionsArrow">‚ñº</span>
                    </div>
                    <div id="advancedOptions" class="collapsible-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Min Likes</label>
                                <input type="number" id="minLikesInput" placeholder="50">
                            </div>
                            <div class="form-group">
                                <label>Min Comments</label>
                                <input type="number" id="minCommentsInput" placeholder="5">
                            </div>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="englishOnlyCheckbox" checked>
                            <label>English captions only</label>
                        </div>
                    </div>
                    
                    <button class="btn-primary" onclick="startCommenting()">üöÄ Start Campaign</button>
                    <div class="loading" id="loading1">
                        <div class="spinner"></div>
                        <span>Running campaign...</span>
                    </div>
                </div>
                
                <!-- Story Engagement -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">üì∫</div>
                        <h2>Story Engagement</h2>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Stories to Watch</label>
                            <input type="number" id="storyCount" value="10" min="1" max="50">
                        </div>
                        <div class="form-group">
                            <label>Target User (optional)</label>
                            <input type="text" id="storyTarget" placeholder="Leave empty for feed">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Like %</label>
                            <input type="number" id="storyLikeProbability" value="30" min="0" max="100">
                        </div>
                        <div class="form-group">
                            <label>React %</label>
                            <input type="number" id="storyReactionProbability" value="20" min="0" max="100">
                        </div>
                        <div class="form-group">
                            <label>Emoji</label>
                            <input type="text" id="storyReactionEmoji" value="üî•" maxlength="2">
                        </div>
                    </div>
                    
                    <div class="collapsible-header" onclick="toggleCollapsible('storyAdvanced')">
                        <span>‚öôÔ∏è Advanced Options</span>
                        <span class="arrow" id="storyAdvancedArrow">‚ñº</span>
                    </div>
                    <div id="storyAdvanced" class="collapsible-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Min Watch (sec)</label>
                                <input type="number" id="storyMinWatch" value="5" min="2">
                            </div>
                            <div class="form-group">
                                <label>Max Watch (sec)</label>
                                <input type="number" id="storyMaxWatch" value="9" min="3">
                            </div>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="storyAiReplyEnabled">
                            <label>Enable AI story replies</label>
                        </div>
                        <div id="storyAiOptions" class="hidden">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Max AI Replies</label>
                                    <input type="number" id="storyAiMaxReplies" value="3" min="1" max="20">
                                </div>
                                <div class="form-group">
                                    <label>Reply Tone</label>
                                    <select id="storyAiTone">
                                        <option value="friendly">Friendly</option>
                                        <option value="consultative">Consultative</option>
                                        <option value="hype">High-energy</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Min Confidence %</label>
                                <input type="number" id="storyAiConfidence" value="70" min="0" max="100">
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn-primary" onclick="watchStories()">üëÅÔ∏è Watch Stories</button>
                    <div class="loading" id="loadingStories">
                        <div class="spinner"></div>
                        <span>Watching stories...</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- AUTOMATION TAB -->
        <div id="tab-automation" class="tab-content">
            <div class="card-grid">
                <!-- Direct Messages -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">üí¨</div>
                        <h2>Direct Messages</h2>
                    </div>
                    
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="dmUsername" placeholder="username (no @)">
                    </div>
                    <div class="form-group">
                        <label>Message</label>
                        <textarea id="dmMessage" placeholder="Your message here..."></textarea>
                    </div>
                    
                    <button class="btn-primary" onclick="sendDM()">üì© Send DM</button>
                    <button class="btn-info btn-full" onclick="monitorDMs()">üì¨ Monitor & Auto-Reply</button>
                    
                    <div class="loading" id="loading2">
                        <div class="spinner"></div>
                        <span>Processing...</span>
                    </div>
                </div>
                
                <!-- Tools & Scheduler -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">üõ†Ô∏è</div>
                        <h2>Tools</h2>
                    </div>
                    
                    <div class="collapsible-header" onclick="toggleCollapsible('scraperTools')">
                        <span>üë• Follower Scraper</span>
                        <span class="arrow" id="scraperToolsArrow">‚ñº</span>
                    </div>
                    <div id="scraperTools" class="collapsible-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Target Account</label>
                                <input type="text" id="targetAccount" placeholder="competitor_username">
                            </div>
                            <div class="form-group">
                                <label>Max Followers</label>
                                <input type="number" id="maxFollowers" value="100" min="1" max="1000">
                            </div>
                        </div>
                        <button class="btn-info" onclick="scrapeFollowers()">üë• Scrape Followers</button>
                    </div>
                    
                    <div class="quick-actions mt-2">
                        <button class="btn-secondary btn-sm" onclick="checkScheduler()">‚è∞ Scheduler</button>
                        <button class="btn-secondary btn-sm" onclick="getMyProfile()">üë§ Profile</button>
                        <button class="btn-secondary btn-sm" onclick="checkStatus()">üìä Status</button>
                    </div>
                    
                    <div class="loading" id="loading4">
                        <div class="spinner"></div>
                        <span>Processing...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Command Console -->
        <div class="grid">
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">ü§ñ</div>
                    <h2>AI Command Console</h2>
                </div>
                <div class="ai-chat-log" id="aiChatLog">
                    <div class="ai-chat-bubble assistant">
                        üëã Hi! I'm your automation copilot. Try asking me to run a Miami campaign, watch stories, or show the latest logs.
                    </div>
                </div>
                <div class="ai-chat-input">
                    <input type="text" id="aiCommandInput" placeholder="e.g. Run the Miami location campaign with 5 DMs">
                    <button class="btn-primary" onclick="sendAiCommand()">Send</button>
                </div>
                <div class="loading" id="aiChatLoading">
                    <div class="spinner"></div>
                    <span>Thinking...</span>
                </div>
            </div>
        </div>
        
        <!-- LOGS TAB -->
        <div id="tab-logs" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">üìú</div>
                    <h2>Activity Logs <span id="logCount" style="font-size: 14px; color: #667eea; font-weight: normal;"></span></h2>
                </div>
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <button class="btn-primary" id="liveLogBtn" onclick="toggleLiveLog()">‚ñ∂Ô∏è Start Live Log</button>
                    <select id="logDetailLevel" onchange="viewLogs()" style="padding: 8px; border-radius: 8px; border: 1px solid #e5e7eb;">
                        <option value="all">All Logs (Detailed)</option>
                        <option value="important">Important Only</option>
                    </select>
                </div>
                
                <!-- Stats Bar -->
                <div class="log-stats" id="logStats">
                    <div class="stat-item" onclick="filterByLevel('all')">
                        <span class="stat-count" id="statTotal">0</span>
                        <span class="stat-label">Total</span>
                    </div>
                    <div class="stat-item stat-info" onclick="filterByLevel('info')">
                        <span class="stat-count" id="statInfo">0</span>
                        <span class="stat-label">Info</span>
                    </div>
                    <div class="stat-item stat-warn" onclick="filterByLevel('warn')">
                        <span class="stat-count" id="statWarn">0</span>
                        <span class="stat-label">Warnings</span>
                    </div>
                    <div class="stat-item stat-error" onclick="filterByLevel('error')">
                        <span class="stat-count" id="statError">0</span>
                        <span class="stat-label">Errors</span>
                    </div>
                </div>
                
                <!-- Filters Row -->
                <div class="log-filters">
                    <div class="filter-group">
                        <select id="levelFilter" onchange="applyLogFilters()">
                            <option value="all">All Levels</option>
                            <option value="info">Info</option>
                            <option value="warn">Warnings</option>
                            <option value="error">Errors</option>
                            <option value="debug">Debug</option>
                        </select>
                        <select id="categoryFilter" onchange="applyLogFilters()">
                            <option value="all">All Categories</option>
                            <option value="login">Login</option>
                            <option value="campaign">Campaign</option>
                            <option value="story">Stories</option>
                            <option value="dm">DMs</option>
                            <option value="browser">Browser</option>
                            <option value="proxy">Proxy</option>
                            <option value="scheduler">Scheduler</option>
                            <option value="system">System</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <input type="text" id="logSearch" placeholder="Search logs..." oninput="searchLogs()">
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="log-actions">
                    <button id="liveLogBtn" class="btn-success btn-sm" onclick="toggleLiveLog()">‚ñ∂Ô∏è Live</button>
                    <button class="btn-info btn-sm" onclick="viewLogs()">üîÑ Refresh</button>
                    <button class="btn-secondary btn-sm" onclick="downloadLogs()">üì• Download</button>
                    <button class="btn-secondary btn-sm" onclick="clearLogDisplay()">üóëÔ∏è Clear</button>
                    <button class="btn-secondary btn-sm" onclick="loadScreenshots()">üì∏ Screenshots</button>
                </div>
                
                <!-- Log Container -->
                <div class="log-container" id="logs">
                    <div class="log-entry log-info">
                        <span class="log-time">--:--:--</span>
                        <span class="log-badge badge-system">system</span>
                        <span class="log-message">Loading logs...</span>
                    </div>
                </div>
                
                <!-- Screenshots Gallery -->
                <div class="collapsible-header mt-2" onclick="toggleCollapsible('screenshotGallery')">
                    <span>üì∏ Recent Screenshots</span>
                    <span class="arrow" id="screenshotGalleryArrow">‚ñº</span>
                </div>
                <div id="screenshotGallery" class="collapsible-content">
                    <p style="text-align: center; color: #6b7280; padding: 20px;">Click "Screenshots" to load</p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const API_URL = window.location.origin;

        const aiChatHistory = [];

        async function apiCall(endpoint, method = 'GET', body = null) {
            try {
                const options = {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include'
                };
                if (body) options.body = JSON.stringify(body);
                const response = await fetch(API_URL + endpoint, options);
                return await response.json();
            } catch (error) {
                return { error: error.message };
            }
        }
        
        // Log helper
        function addLog(message) {
            const logs = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            if (message.includes('‚úÖ')) entry.classList.add('log-success');
            else if (message.includes('‚ùå')) entry.classList.add('log-error');
            else if (message.includes('‚ö†Ô∏è')) entry.classList.add('log-warning');
            else if (message.includes('‚ÑπÔ∏è') || message.includes('üì°')) entry.classList.add('log-info');
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logs.insertBefore(entry, logs.firstChild);
        }

        function appendAiMessage(role, text) {
            const container = document.getElementById('aiChatLog');
            if (!container) return;
            const bubble = document.createElement('div');
            bubble.className = `ai-chat-bubble ${role}`;
            bubble.innerHTML = text.replace(/\n/g, '<br>');
            container.appendChild(bubble);
            container.scrollTop = container.scrollHeight;
        }

        function toggleAiChatLoading(active) {
            const loading = document.getElementById('aiChatLoading');
            if (!loading) return;
            loading.classList.toggle('active', !!active);
        }

        async function sendAiCommand() {
            const input = document.getElementById('aiCommandInput');
            if (!input) return;
            const message = input.value.trim();
            if (!message.length) return;

            appendAiMessage('user', message);
            aiChatHistory.push({ role: 'user', content: message });
            input.value = '';
            toggleAiChatLoading(true);

            const payload = {
                message,
                history: aiChatHistory.slice(-6),
            };

            const result = await apiCall('/api/ai/command', 'POST', payload);
            toggleAiChatLoading(false);

            if (result.error) {
                appendAiMessage('assistant', `‚ùå ${result.error}`);
                aiChatHistory.push({ role: 'assistant', content: `Error: ${result.error}` });
                return;
            }

            const plan = result.plan || {};
            const execution = result.execution || {};
            const confidencePct = plan.confidence ? Math.round(plan.confidence * 100) : 0;
            const summaryLine = plan.summary
                ? `üß† ${plan.summary} (${confidencePct}% confidence)`
                : 'üß† Command interpreted.';
            const executionLine = execution.message
                ? `${execution.success ? '‚úÖ' : '‚ö†Ô∏è'} ${execution.message}`
                : 'No follow-up action was executed.';

            let detailsBlock = '';
            if (execution.details?.logs) {
                const snippet = execution.details.logs.slice(-5).join('<br>');
                detailsBlock = `<div class="ai-log-snippet">${snippet}</div>`;
            } else if (execution.details?.help) {
                detailsBlock = `<div class="ai-log-snippet">${execution.details.help.replace(/\n/g, '<br>')}</div>`;
            } else if (execution.details) {
                detailsBlock = `<div class="ai-log-snippet">${JSON.stringify(execution.details, null, 2)}</div>`;
            }

            appendAiMessage('assistant', `${summaryLine}<br>${executionLine}${detailsBlock ? `<br>${detailsBlock}` : ''}`);
            aiChatHistory.push({
                role: 'assistant',
                content: `${summaryLine}\n${executionLine}`,
            });
        }

        function toggleCollapsible(id) {
            const content = document.getElementById(id);
            const arrow = document.getElementById(id + 'Arrow');
            content.classList.toggle('active');
            arrow.classList.toggle('active');
        }

        function updateInteractionFields() {
            const mode = document.getElementById('interactionMode').value;
            document.getElementById('targetUsernameGroup').classList.add('hidden');
            document.getElementById('hashtagGroup').classList.add('hidden');
            document.getElementById('locationGroup').classList.add('hidden');
            document.getElementById('competitorGroup').classList.add('hidden');
            
            if (mode === 'user') document.getElementById('targetUsernameGroup').classList.remove('hidden');
            else if (mode === 'hashtag') document.getElementById('hashtagGroup').classList.remove('hidden');
            else if (mode === 'location') document.getElementById('locationGroup').classList.remove('hidden');
            else if (mode === 'competitor_followers') document.getElementById('competitorGroup').classList.remove('hidden');
        }
        
        // Toggle proxy fields
        function toggleProxyFields() {
            const enabled = document.getElementById('proxyEnabled').checked;
            document.getElementById('proxyFields').classList.toggle('hidden', !enabled);
        }
        
        // Toggle story AI options
        function toggleStoryAiOptions() {
            const enabled = document.getElementById('storyAiReplyEnabled').checked;
            document.getElementById('storyAiOptions').classList.toggle('hidden', !enabled);
        }
        
        // Login
        async function login() {
            const loading = document.getElementById('loadingLogin');
            loading.classList.add('active');
            
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const rememberMe = document.getElementById('rememberMeCheckbox').checked;
            
            if (!username || !password) {
                alert('Please enter username and password');
                loading.classList.remove('active');
                return;
            }
            
            if (rememberMe) localStorage.setItem('savedUsername', username);
            
            addLog('üîê Logging in...');
            const result = await apiCall('/api/login', 'POST', { username, password, rememberMe });
            
            loading.classList.remove('active');
            if (result.error) {
                addLog('‚ùå Login failed: ' + result.error);
            } else {
                statusDiv.className = 'status-message success mt-2';
                statusDiv.innerHTML = `‚úÖ Logged in as @${result.username || username}`;
                addLog(`‚úÖ Successfully logged in as @${result.username || username}`);
                addLog(rememberMe ? 'üîí Session will last 30 days' : '‚è∞ Session will last 24 hours');
                document.getElementById('loginPassword').value = '';
                // Save username to localStorage for convenience
                if (rememberMe) {
                    localStorage.setItem('savedUsername', username);
                }
                checkStatus();
            }
        }
        
        // Logout
        async function logout() {
            addLog('üö™ Logging out...');
            document.cookie = 'token=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/';
            await apiCall('/api/logout', 'POST');
            addLog('‚úÖ Logged out');
            checkStatus();
        }
        
        // Clear cookies
        async function clearCookies() {
            addLog('üßπ Clearing cookies...');
            const result = await apiCall('/api/clear-cookies', 'DELETE');
            addLog(result.error ? '‚ùå ' + result.error : '‚úÖ Cookies cleared');
        }
        
        // Load proxy settings
        async function loadProxySettings() {
            const result = await apiCall('/api/proxy/status');
            if (result.enabled) {
                document.getElementById('proxyEnabled').checked = true;
                document.getElementById('proxyHost').value = result.host || '';
                document.getElementById('proxyPort').value = result.port || '';
                document.getElementById('proxyUsername').value = result.username || '';
                toggleProxyFields();
                updateProxyStatusPill(true);
            }
        }
        
        // Save proxy settings
        async function saveProxySettings() {
            const loading = document.getElementById('loadingProxy');
            loading.classList.add('active');
            
            const enabled = document.getElementById('proxyEnabled').checked;
            const host = document.getElementById('proxyHost').value.trim();
            const port = document.getElementById('proxyPort').value.trim();
            const username = document.getElementById('proxyUsername').value.trim();
            const password = document.getElementById('proxyPassword').value;
            
            const result = await apiCall('/api/proxy/configure', 'POST', { enabled, host, port, username, password });
            
            loading.classList.remove('active');
            if (result.error) {
                addLog('‚ùå Proxy error: ' + result.error);
            } else {
                addLog('‚úÖ Proxy settings saved');
                updateProxyStatusPill(enabled);
            }
        }
        
        function updateProxyStatusPill(enabled) {
            const pill = document.getElementById('proxyStatus');
            if (enabled) {
                pill.innerHTML = '<span>üåê</span><span>Proxy Active</span>';
                pill.className = 'status-pill online';
            } else {
                pill.innerHTML = '<span>üåê</span><span>No Proxy</span>';
                pill.className = 'status-pill';
            }
        }
        
        // Check status
        async function checkStatus() {
            const result = await apiCall('/api/status');
            const loginPill = document.getElementById('loginStatus');
            const loginForm = document.getElementById('loginForm');
            const loggedInControls = document.getElementById('loggedInControls');
            
            if (result.authenticated) {
                loginPill.className = 'status-pill online';
                loginPill.innerHTML = '<div class="pulse"></div><span>@' + (result.username || 'Online') + '</span>';
                loginForm.classList.add('hidden');
                loggedInControls.classList.remove('hidden');
            } else {
                loginPill.className = 'status-pill offline';
                loginPill.innerHTML = '<div class="pulse"></div><span>Offline</span>';
                loginForm.classList.remove('hidden');
                loggedInControls.classList.add('hidden');
            }
        }
        
        // Start commenting campaign
        async function startCommenting() {
            const loading = document.getElementById('loading1');
            loading.classList.add('active');
            
            const mode = document.getElementById('interactionMode').value;
            const maxPosts = parseInt(document.getElementById('maxPostsInput').value, 10) || 10;
            const targetInput = document.getElementById('interactionTarget').value.trim();
            const hashtagInput = document.getElementById('interactionHashtags').value;
            const locationPath = document.getElementById('locationPath').value.trim();
            const competitorUsername = document.getElementById('competitorUsername').value.trim();
            const minLikes = parseInt(document.getElementById('minLikesInput').value, 10);
            const minComments = parseInt(document.getElementById('minCommentsInput').value, 10);
            const englishOnly = document.getElementById('englishOnlyCheckbox').checked;
            
            const hashtags = hashtagInput.split(',').map(t => t.replace(/^#/, '').trim()).filter(Boolean);
            
            let targetUsername = targetInput;
            if (mode === 'feed') targetUsername = 'feed';
            else if (mode === 'explore') targetUsername = 'explore';
            else if (mode === 'hashtag') {
                if (!hashtags.length) { alert('Please enter at least one hashtag'); loading.classList.remove('active'); return; }
                targetUsername = `#${hashtags[0]}`;
            } else if (mode === 'location') {
                if (!locationPath) { alert('Please enter a location path'); loading.classList.remove('active'); return; }
                targetUsername = `location:${locationPath}`;
            } else if (mode === 'competitor_followers') {
                if (!competitorUsername) { alert('Please enter a competitor username'); loading.classList.remove('active'); return; }
                targetUsername = undefined;
            }
            
            const payload = {
                targetUsername, maxPosts, mode,
                options: {
                    mode,
                    hashtags: hashtags.length ? hashtags : undefined,
                    locationPath: locationPath || undefined,
                    competitorUsername: competitorUsername || undefined,
                    engagement: { minLikes: isNaN(minLikes) ? undefined : minLikes, minComments: isNaN(minComments) ? undefined : minComments },
                    englishOnly: englishOnly || undefined
                }
            };
            
            addLog(`üöÄ Starting ${mode} campaign (${maxPosts} posts)...`);
            const result = await apiCall('/api/interact', 'POST', payload);
            loading.classList.remove('active');
            addLog(result.error ? '‚ùå Error: ' + result.error : '‚úÖ ' + result.message);
        }
        
        // Watch stories
        async function watchStories() {
            const loading = document.getElementById('loadingStories');
            loading.classList.add('active');
            
            const count = parseInt(document.getElementById('storyCount').value, 10) || 10;
            const target = document.getElementById('storyTarget').value.trim();
            const likeProb = parseFloat(document.getElementById('storyLikeProbability').value) / 100 || 0.3;
            const reactProb = parseFloat(document.getElementById('storyReactionProbability').value) / 100 || 0.2;
            const emoji = document.getElementById('storyReactionEmoji').value.trim() || 'üî•';
            const minWatch = parseFloat(document.getElementById('storyMinWatch').value) * 1000 || 5000;
            const maxWatch = parseFloat(document.getElementById('storyMaxWatch').value) * 1000 || 9000;
            const aiEnabled = document.getElementById('storyAiReplyEnabled').checked;
            
            const payload = {
                storyCount: count,
                targetUsername: target || undefined,
                likeProbability: likeProb,
                reactionProbability: reactProb,
                reactionEmoji: emoji,
                minWatchTimeMs: minWatch,
                maxWatchTimeMs: maxWatch
            };
            
            if (aiEnabled) {
                payload.aiReply = {
                    enabled: true,
                    maxReplies: parseInt(document.getElementById('storyAiMaxReplies').value, 10),
                    tone: document.getElementById('storyAiTone').value,
                    minConfidence: parseFloat(document.getElementById('storyAiConfidence').value) / 100
                };
            }
            
            addLog(`üëÅÔ∏è Watching ${count} stories...`);
            const result = await apiCall('/api/stories/watch', 'POST', payload);
            loading.classList.remove('active');
            addLog(result.error ? '‚ùå Error: ' + result.error : '‚úÖ ' + result.message);
        }
        
        // Send DM
        async function sendDM() {
            const username = document.getElementById('dmUsername').value.trim();
            const message = document.getElementById('dmMessage').value.trim();
            if (!username || !message) { alert('Please fill in both username and message'); return; }
            
            const loading = document.getElementById('loading2');
            loading.classList.add('active');
            addLog(`üì© Sending DM to @${username}...`);
            
            const result = await apiCall('/api/dm', 'POST', { username, message });
            loading.classList.remove('active');
            
            if (result.error) {
                addLog('‚ùå Error: ' + result.error);
            } else {
                addLog('‚úÖ DM sent to @' + username);
                document.getElementById('dmUsername').value = '';
                document.getElementById('dmMessage').value = '';
            }
        }
        
        // Monitor DMs
        async function monitorDMs() {
            const loading = document.getElementById('loading2');
            loading.classList.add('active');
            addLog('üì¨ Monitoring DMs...');
            const result = await apiCall('/api/monitor-dms', 'POST');
            loading.classList.remove('active');
            addLog(result.error ? '‚ùå Error: ' + result.error : '‚úÖ ' + result.message);
        }
        
        async function clearDMCache() {
            if (!confirm('Clear the replied conversations cache? This will allow the bot to reply to previously-handled DMs again.')) {
                return;
            }
            
            addLog('üóëÔ∏è Clearing replied conversations cache...');
            const result = await apiCall('/api/dms/clear-cache', 'POST');
            
            if (result.error) {
                addLog('‚ùå Error: ' + result.error);
            } else {
                addLog('‚úÖ ' + result.message);
            }
        }

        async function scrapeFollowers() {
            const targetAccount = document.getElementById('targetAccount').value.trim();
            const maxFollowers = parseInt(document.getElementById('maxFollowers').value);
            if (!targetAccount) { alert('Please enter a target account'); return; }
            
            const loading = document.getElementById('loading4');
            loading.classList.add('active');
            addLog(`üë• Scraping followers from @${targetAccount}...`);
            
            const result = await apiCall('/api/scrape-followers', 'POST', { targetAccount, maxFollowers });
            loading.classList.remove('active');
            addLog(result.error ? '‚ùå Error: ' + result.error : `‚úÖ Scraped ${result.followers?.length || 0} followers`);
        }
        
        // Check scheduler
        async function checkScheduler() {
            const loading = document.getElementById('loading4');
            loading.classList.add('active');
            const result = await apiCall('/api/scheduler/status');
            loading.classList.remove('active');
            addLog(result.error ? '‚ùå ' + result.error : `‚è∞ Scheduler: ${result.isRunning ? 'Running ‚úÖ' : 'Stopped ‚ùå'}`);
        }
        
        // Get profile
        async function getMyProfile() {
            const loading = document.getElementById('loading4');
            loading.classList.add('active');
            const result = await apiCall('/api/me');
            loading.classList.remove('active');
            addLog(result.error ? '‚ùå ' + result.error : `üë§ Username: ${result.username || 'Unknown'}`);
        }
        
        // Load screenshots
        async function loadScreenshots() {
            const gallery = document.getElementById('screenshotGallery');
            gallery.innerHTML = '<p style="text-align: center; padding: 20px;">Loading...</p>';
            toggleCollapsible('screenshotGallery');
            
            const result = await apiCall('/api/screenshots/list');
            
            if (result.error || !result.screenshots || result.screenshots.length === 0) {
                gallery.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">No screenshots found</p>';
                return;
            }
            
            gallery.innerHTML = '';
            result.screenshots.slice(0, 10).forEach(s => {
                const item = document.createElement('div');
                item.style.cssText = 'padding: 8px; margin: 4px 0; background: #f9fafb; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 8px;';
                item.onclick = () => window.open(`${API_URL}/api/screenshots/view/${s.type}/${s.path}`, '_blank');
                item.innerHTML = `<span>${s.type === 'post' ? 'üìÑ' : s.type === 'profile' ? 'üë§' : 'üì∞'}</span><span style="flex:1; font-size: 12px;">${s.name}</span><span style="color: #667eea;">üëÅÔ∏è</span>`;
                gallery.appendChild(item);
            });
        }
        
        // View logs with structured data
        let logRefreshInterval = null;
        let cachedLogs = [];
        
        async function viewLogs() {
            const result = await apiCall('/api/logs/recent?lines=1000'); // Increased from 500 to 1000
            
            let url = '/api/logs/recent?lines=200';
            if (levelFilter !== 'all') url += `&level=${levelFilter}`;
            if (categoryFilter !== 'all') url += `&category=${categoryFilter}`;
            
            const result = await apiCall(url);
            if (result.error) {
                console.error('Log fetch error:', result.error);
                return;
            }
            
            const logs = document.getElementById('logs');
            let lines = result.logs || [];
            
            // Filter based on detail level
            const detailLevel = document.getElementById('logDetailLevel')?.value || 'all';
            if (detailLevel === 'important') {
                // Only show important logs (errors, successes, major actions)
                lines = lines.filter(line => {
                    return line.includes('‚úÖ') || line.includes('‚ùå') || line.includes('‚ö†Ô∏è') ||
                           line.includes('error:') || line.includes('Successfully') ||
                           line.includes('Starting') || line.includes('Complete') ||
                           line.includes('Liked story') || line.includes('AI replied') ||
                           line.includes('Reply sent') || line.includes('Campaign') ||
                           line.includes('logged in') || line.includes('Failed');
                });
            }
            
            // Clear existing logs and add new ones
            logs.innerHTML = '';
            if (lines.length === 0) {
                const entry = document.createElement('div');
                entry.className = 'log-entry';
                if (line.includes('‚úÖ') || line.includes('Successfully')) entry.classList.add('log-success');
                else if (line.includes('‚ùå') || line.includes('error:')) entry.classList.add('log-error');
                else if (line.includes('‚ö†Ô∏è') || line.includes('warn:')) entry.classList.add('log-warning');
                else if (line.includes('info:')) entry.classList.add('log-info');
                entry.textContent = line;
                logs.appendChild(entry);
            } else {
                // Show newest first (reverse the array)
                lines.reverse().forEach(line => {
                    const entry = document.createElement('div');
                    entry.className = 'log-entry';
                    
                    // Enhanced color coding to match terminal output
                    if (line.includes('‚úÖ') || line.includes('Successfully') || line.includes('liked') || line.includes('Comment posted') || 
                        line.includes('Liked story') || line.includes('‚ù§Ô∏è') || line.includes('Reply sent') || 
                        line.includes('Story reply sent') || line.includes('AI replied')) {
                        entry.classList.add('log-success');
                    } else if (line.includes('‚ùå') || line.includes('error:') || line.includes('Error') || 
                               line.includes('failed') || line.includes('Failed') || line.includes('timeout')) {
                        entry.classList.add('log-error');
                    } else if (line.includes('‚ö†Ô∏è') || line.includes('warn:') || line.includes('Warning') || 
                               line.includes('Skipping') || line.includes('No dismissal') || line.includes('Unable to')) {
                        entry.classList.add('log-warning');
                    } else if (line.includes('info:') || line.includes('üì°') || line.includes('üìç') || 
                               line.includes('üîç') || line.includes('üì∏') || line.includes('üì©') || 
                               line.includes('üéûÔ∏è') || line.includes('Starting story') || line.includes('Watching') ||
                               line.includes('Checking for') || line.includes('Notification') || 
                               line.includes('screenshot saved') || line.includes('Saved screenshot') ||
                               line.includes('Loaded cookies') || line.includes('logged in') ||
                               line.includes('Navigating') || line.includes('Opening') ||
                               line.includes('üí¨') || line.includes('Attempting to') || line.includes('Found story')) {
                        entry.classList.add('log-info');
                    } else if (line.includes('ü§ñ') || line.includes('AI Story Analysis') || 
                               line.includes('AI Generated') || line.includes('confidence')) {
                        entry.classList.add('log-info');
                        entry.style.backgroundColor = '#f0f9ff'; // Light blue for AI logs
                        entry.style.borderLeft = '3px solid #3b82f6';
                    }
                    
                    entry.textContent = line;
                    logs.appendChild(entry);
                });
            }
            
            // Update log count
            const logCount = document.getElementById('logCount');
            logCount.textContent = `(${lines.length} lines)`;
            
            // Auto-scroll to bottom (newest logs)
            logs.scrollTop = logs.scrollHeight;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function filterByLevel(level) {
            document.getElementById('levelFilter').value = level;
            applyLogFilters();
        }
        
        function applyLogFilters() {
            viewLogs();
        }
        
        function searchLogs() {
            renderLogs(cachedLogs);
        }
        
        function clearLogDisplay() {
            document.getElementById('logs').innerHTML = `<div class="log-entry log-info">
                <span class="log-time">--:--:--</span>
                <span class="log-badge badge-system">system</span>
                <span class="log-message">Log display cleared</span>
            </div>`;
            cachedLogs = [];
        }
        
        function downloadLogs() {
            if (cachedLogs.length === 0) {
                alert('No logs to download. Click Refresh first.');
                return;
            }
            
            const logText = cachedLogs.map(log => 
                `[${log.timestamp}] [${log.level.toUpperCase()}] [${log.category}] ${log.message}`
            ).join('\n');
            
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `instagram-bot-logs-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function toggleLiveLog() {
            const btn = document.getElementById('liveLogBtn');
            if (logRefreshInterval) {
                clearInterval(logRefreshInterval);
                logRefreshInterval = null;
                btn.textContent = '‚ñ∂Ô∏è Live';
                btn.className = 'btn-success btn-sm';
            } else {
                // Start live refresh
                viewLogs(); // Fetch immediately
                logRefreshInterval = setInterval(viewLogs, 2000); // Refresh every 2 seconds (faster)
                btn.textContent = '‚è∏Ô∏è Stop Live Log';
                btn.classList.remove('btn-success');
                btn.classList.add('btn-danger');
                addLog('‚ñ∂Ô∏è Live log started (updates every 2s)');
            }
        }
        
        // Initialize
        window.onload = () => {
            checkStatus();
            updateInteractionFields();
            
            // Auto-fill username if previously saved
            const savedUsername = localStorage.getItem('savedUsername');
            if (savedUsername) {
                const usernameInput = document.getElementById('loginUsername');
                if (usernameInput) {
                    usernameInput.value = savedUsername;
                }
            }
            loadProxySettings();
            viewLogs(); // Load logs on startup
            
            const savedUsername = localStorage.getItem('savedUsername');
            if (savedUsername) document.getElementById('loginUsername').value = savedUsername;
            
            document.getElementById('proxyEnabled').addEventListener('change', toggleProxyFields);
            document.getElementById('storyAiReplyEnabled').addEventListener('change', toggleStoryAiOptions);
            toggleStoryAiOptions();

            const aiInput = document.getElementById('aiCommandInput');
            if (aiInput) {
                aiInput.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter' && !event.shiftKey) {
                        event.preventDefault();
                        sendAiCommand();
                    }
                });
            }
            
            addLog('ü§ñ Dashboard loaded');
        };
        
        setInterval(checkStatus, 30000);
    </script>
</body>
</html>
