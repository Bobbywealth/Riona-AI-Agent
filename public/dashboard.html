<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instagram Bot Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .card h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
        }
        button {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .btn-success {
            background: #10b981;
            color: white;
        }
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        .btn-info {
            background: #3b82f6;
            color: white;
        }
        input, textarea {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
        }
        input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        .status {
            padding: 15px;
            background: #f3f4f6;
            border-radius: 8px;
            margin: 10px 0;
        }
        .log {
            background: #1f2937;
            color: #10b981;
            padding: 15px;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin-top: 15px;
        }
        .loading {
            display: none;
            text-align: center;
            color: #667eea;
            margin: 10px 0;
        }
        .loading.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü§ñ Instagram Bot Dashboard</h1>
        
        <div class="grid">
            <!-- Login Control -->
            <div class="card">
                <h2>üîê Account Control</h2>
                <input type="text" id="loginUsername" placeholder="Instagram Username">
                <input type="password" id="loginPassword" placeholder="Instagram Password">
                <button class="btn-success" onclick="login()">
                    üîì Login
                </button>
                <button class="btn-danger" onclick="logout()">
                    üö™ Logout
                </button>
                <button class="btn-info" onclick="clearCookies()">
                    üßπ Clear Cookies
                </button>
                <div class="loading" id="loadingLogin">‚è≥ Processing...</div>
                <div class="status" id="loginStatus" style="margin-top: 10px; font-size: 12px;">
                    Not logged in
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card">
                <h2>‚ö° Quick Actions</h2>
                <label style="font-weight:600;">Targeting Mode</label>
                <select id="interactionMode" onchange="updateInteractionFields()" style="width:100%;padding:12px;margin:8px 0;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;">
                    <option value="feed">Recent Feed (accounts you follow)</option>
                    <option value="explore">Explore Page</option>
                    <option value="user">Specific User</option>
                    <option value="hashtag">Hashtag</option>
                    <option value="location">Location</option>
                    <option value="competitor_followers">Competitor Followers</option>
                </select>
                <input type="number" id="maxPostsInput" placeholder="Max posts (default 10)" value="10">
                <div id="targetUsernameGroup" style="display:none;">
                    <input type="text" id="interactionTarget" placeholder="Target username (no @)">
                </div>
                <div id="hashtagGroup" style="display:none;">
                    <input type="text" id="interactionHashtags" placeholder="#marketing, #travel (comma separated)">
                </div>
                <div id="locationGroup" style="display:none;">
                    <input type="text" id="locationPath" placeholder="Location path (e.g., 212999109/new-york-new-york)">
                </div>
                <div id="competitorGroup" style="display:none;">
                    <input type="text" id="competitorUsername" placeholder="Competitor username (no @)">
                </div>
                <div id="followersGroup" style="display:none;">
                    <input type="number" id="followersToEngage" placeholder="Followers to engage (e.g., 5)" value="5">
                </div>
                <div id="postsPerFollowerGroup" style="display:none;">
                    <input type="number" id="postsPerFollower" placeholder="Posts per follower (e.g., 1)" value="1">
                </div>
                <div id="engagementFilters">
                    <label style="font-weight:600;">Engagement Filters (optional)</label>
                    <input type="number" id="minLikesInput" placeholder="Min likes (e.g., 50)">
                    <input type="number" id="minCommentsInput" placeholder="Min comments (e.g., 5)">
                </div>
                <div style="margin-top:10px;">
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                        <input type="checkbox" id="englishOnlyCheckbox" checked>
                        <span>Only interact with English captions</span>
                    </label>
                </div>
                <button class="btn-primary" onclick="startCommenting()">
                    üí¨ Start Commenting
                </button>
                <button class="btn-success" onclick="checkStatus()">
                    üìä Check Status
                </button>
                <button class="btn-info" onclick="viewLogs()">
                    üìã View Logs
                </button>
                <div class="loading" id="loading1">‚è≥ Processing...</div>
            </div>

            <!-- Story Viewer -->
            <div class="card">
                <h2>üì∫ Story Viewer</h2>
                <input type="number" id="storyCount" placeholder="Stories to watch (e.g., 10)" value="10">
                <input type="text" id="storyTarget" placeholder="Specific username (optional, no @)">
                <label style="font-weight:600;">Like Probability (%)</label>
                <input type="number" id="storyLikeProbability" placeholder="e.g., 30" value="30" min="0" max="100">
                <label style="font-weight:600;">Reaction Probability (%)</label>
                <input type="number" id="storyReactionProbability" placeholder="e.g., 20" value="20" min="0" max="100">
                <input type="text" id="storyReactionEmoji" placeholder="Reaction emoji (optional)" value="üî•">
                <div style="display:flex;gap:10px;">
                    <input type="number" id="storyMinWatch" placeholder="Min seconds" value="5" min="2" style="flex:1;">
                    <input type="number" id="storyMaxWatch" placeholder="Max seconds" value="9" min="3" style="flex:1;">
                </div>
                <button class="btn-primary" onclick="watchStories()">
                    üëÅÔ∏è Watch Stories
                </button>
                <div class="loading" id="loadingStories">‚è≥ Watching stories...</div>
            </div>

            <!-- Send DM -->
            <div class="card">
                <h2>üì© Send Direct Message</h2>
                <input type="text" id="dmUsername" placeholder="Username (without @)">
                <textarea id="dmMessage" rows="3" placeholder="Your message..."></textarea>
                <button class="btn-primary" onclick="sendDM()">Send DM</button>
                <div class="loading" id="loading2">‚è≥ Sending...</div>
            </div>

            <!-- Scrape Followers -->
            <div class="card">
                <h2>üë• Scrape Followers</h2>
                <input type="text" id="targetAccount" placeholder="Target account (e.g., garyvee)">
                <input type="number" id="maxFollowers" placeholder="Max followers (e.g., 50)" value="50">
                <button class="btn-info" onclick="scrapeFollowers()">Scrape Followers</button>
                <div class="loading" id="loading3">‚è≥ Scraping...</div>
            </div>

            <!-- Advanced Features -->
            <div class="card">
                <h2>üöÄ Advanced</h2>
                <button class="btn-primary" onclick="monitorDMs()">
                    üì¨ Monitor & Reply to DMs
                </button>
                <button class="btn-info" onclick="checkScheduler()">
                    ‚è∞ Check Scheduler Status
                </button>
                <button class="btn-success" onclick="getMyProfile()">
                    üë§ Get My Profile
                </button>
                <div class="loading" id="loading4">‚è≥ Processing...</div>
            </div>

            <!-- Proxy Settings -->
            <div class="card">
                <h2>üîí Proxy Settings</h2>
                <div style="margin-bottom: 10px;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="proxyEnabled" style="width: auto; margin-right: 10px;">
                        <span>Enable Proxy</span>
                    </label>
                </div>
                <input type="text" id="proxyHost" placeholder="Proxy Host (e.g., proxy.example.com)">
                <input type="text" id="proxyPort" placeholder="Proxy Port (e.g., 8080)">
                <input type="text" id="proxyUsername" placeholder="Proxy Username (optional)">
                <input type="password" id="proxyPassword" placeholder="Proxy Password (optional)">
                <button class="btn-success" onclick="saveProxySettings()">
                    üíæ Save Proxy Settings
                </button>
                <button class="btn-info" onclick="testProxy()">
                    üß™ Test Proxy
                </button>
                <div class="loading" id="loading5">‚è≥ Testing...</div>
                <div class="status" id="proxyStatus" style="margin-top: 10px; font-size: 12px;">
                    Proxy settings not configured
                </div>
            </div>
        </div>

        <!-- Status Display -->
        <div class="card">
            <h2>üìä Bot Status</h2>
            <div class="status" id="status">
                Click "Check Status" to see bot status...
            </div>
        </div>

        <!-- Logs -->
        <div class="card">
            <h2>üìú Recent Activity</h2>
            <div class="log" id="logs">
                Logs will appear here...
            </div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;

        async function apiCall(endpoint, method = 'GET', body = null) {
            try {
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include'
                };
                if (body) options.body = JSON.stringify(body);
                
                const response = await fetch(`${API_URL}${endpoint}`, options);
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                return { error: error.message };
            }
        }

        function addLog(message) {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            logs.innerHTML += `\n[${timestamp}] ${message}`;
            logs.scrollTop = logs.scrollHeight;
        }

        async function startCommenting() {
            const loading = document.getElementById('loading1');
            loading.classList.add('active');
            
            const mode = document.getElementById('interactionMode').value;
            const maxPostsValue = parseInt(document.getElementById('maxPostsInput').value, 10);
            const maxPosts = Number.isNaN(maxPostsValue) ? 10 : maxPostsValue;
            const targetInput = document.getElementById('interactionTarget').value.trim();
            const hashtagInput = document.getElementById('interactionHashtags').value;
            const locationPath = document.getElementById('locationPath').value.trim();
            const competitorUsername = document.getElementById('competitorUsername').value.trim();
            const followersToEngage = parseInt(document.getElementById('followersToEngage').value, 10);
            const postsPerFollower = parseInt(document.getElementById('postsPerFollower').value, 10);
            const minLikes = parseInt(document.getElementById('minLikesInput').value, 10);
            const minComments = parseInt(document.getElementById('minCommentsInput').value, 10);
            const englishOnly = document.getElementById('englishOnlyCheckbox').checked;

            const hashtags = hashtagInput
                .split(',')
                .map((tag) => tag.replace(/^#/, '').trim().toLowerCase())
                .filter((tag) => tag.length);

            let targetUsername = targetInput;
            if (mode === 'feed') {
                targetUsername = 'feed';
            } else if (mode === 'explore') {
                targetUsername = 'explore';
            } else if (mode === 'hashtag') {
                if (!hashtags.length) {
                    alert('Please enter at least one hashtag.');
                    loading.classList.remove('active');
                    return;
                }
                targetUsername = `#${hashtags[0]}`;
            } else if (mode === 'location') {
                if (!locationPath) {
                    alert('Please enter a location path.');
                    loading.classList.remove('active');
                    return;
                }
                targetUsername = `location:${locationPath}`;
            } else if (mode === 'user') {
                if (!targetUsername) {
                    alert('Please enter a username to target.');
                    loading.classList.remove('active');
                    return;
                }
            } else if (mode === 'competitor_followers') {
                targetUsername = undefined;
                if (!competitorUsername) {
                    alert('Please enter a competitor username.');
                    loading.classList.remove('active');
                    return;
                }
            }

            const payload = {
                targetUsername,
                maxPosts,
                mode,
                options: {
                    mode,
                    hashtags: hashtags.length ? hashtags : undefined,
                    locationPath: locationPath || undefined,
                    competitorUsername: competitorUsername || undefined,
                    followersToEngage: Number.isNaN(followersToEngage) ? undefined : followersToEngage,
                    postsPerFollower: Number.isNaN(postsPerFollower) ? undefined : postsPerFollower,
                    engagement: {
                        minLikes: Number.isNaN(minLikes) ? undefined : minLikes,
                        minComments: Number.isNaN(minComments) ? undefined : minComments,
                    },
                    englishOnly: englishOnly ? true : undefined,
                },
            };

            if (
                payload.options.engagement &&
                payload.options.engagement.minLikes === undefined &&
                payload.options.engagement.minComments === undefined
            ) {
                delete payload.options.engagement;
            }

            addLog(`üöÄ Starting ${mode} session (max ${maxPosts} posts)...`);
            const result = await apiCall('/api/interact', 'POST', payload);
            
            loading.classList.remove('active');
            if (result.error) {
                addLog('‚ùå Error: ' + result.error);
            } else {
                addLog(`‚úÖ ${result.message} (mode: ${result.mode || mode})`);
            }
        }

        function updateInteractionFields() {
            const mode = document.getElementById('interactionMode').value;
            const toggle = (id, show) => {
                const el = document.getElementById(id);
                if (!el) return;
                el.style.display = show ? 'block' : 'none';
            };

            toggle('targetUsernameGroup', mode === 'user');
            toggle('hashtagGroup', mode === 'hashtag');
            toggle('locationGroup', mode === 'location');
            toggle('competitorGroup', mode === 'competitor_followers');
            toggle('followersGroup', mode === 'competitor_followers');
            toggle('postsPerFollowerGroup', mode === 'competitor_followers');
        }

        async function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!username || !password) {
                alert('Please enter both username and password');
                return;
            }

            const loading = document.getElementById('loadingLogin');
            const statusDiv = document.getElementById('loginStatus');
            loading.classList.add('active');
            statusDiv.textContent = 'Logging in...';
            addLog(`üîê Attempting login as @${username}...`);
            
            const result = await apiCall('/api/login', 'POST', { username, password });
            
            loading.classList.remove('active');
            if (result.error) {
                statusDiv.textContent = '‚ùå Login failed: ' + result.error;
                statusDiv.style.color = '#ef4444';
                addLog('‚ùå Login failed: ' + result.error);
            } else {
                statusDiv.textContent = `‚úÖ Logged in as @${username}`;
                statusDiv.style.color = '#10b981';
                addLog(`‚úÖ Successfully logged in as @${username}`);
                // Clear password field for security
                document.getElementById('loginPassword').value = '';
                // Update main status
                checkStatus();
            }
        }

        async function logout() {
            const loading = document.getElementById('loadingLogin');
            const statusDiv = document.getElementById('loginStatus');
            loading.classList.add('active');
            addLog('üö™ Logging out...');
            
            const result = await apiCall('/api/logout', 'POST');
            
            loading.classList.remove('active');
            statusDiv.textContent = 'üö™ Logged out';
            statusDiv.style.color = '#6b7280';
            addLog('‚úÖ Logged out successfully');
            checkStatus();
        }

        async function clearCookies() {
            const loading = document.getElementById('loadingLogin');
            const statusDiv = document.getElementById('loginStatus');
            loading.classList.add('active');
            addLog('üßπ Clearing cookies...');
            
            const result = await apiCall('/api/clear-cookies', 'DELETE');
            
            loading.classList.remove('active');
            if (result.error) {
                statusDiv.textContent = '‚ùå Error clearing cookies';
                addLog('‚ùå Error: ' + result.error);
            } else {
                statusDiv.textContent = 'üßπ Cookies cleared';
                statusDiv.style.color = '#6b7280';
                addLog('‚úÖ Cookies cleared successfully');
            }
        }

        async function checkStatus() {
            const loading = document.getElementById('loading1');
            loading.classList.add('active');
            
            const result = await apiCall('/api/status');
            
            loading.classList.remove('active');
            
            // Update main status card
            document.getElementById('status').innerHTML = `
                <strong>Status:</strong> ${result.status || 'Unknown'}<br>
                <strong>Logged In:</strong> ${result.authenticated ? '‚úÖ Yes' : '‚ùå No'}<br>
                <strong>Server Time:</strong> ${new Date().toLocaleString()}
            `;
            
            // Update login status
            const loginStatus = document.getElementById('loginStatus');
            if (result.authenticated) {
                loginStatus.textContent = '‚úÖ Logged in';
                loginStatus.style.color = '#10b981';
            } else {
                loginStatus.textContent = '‚ùå Not logged in';
                loginStatus.style.color = '#ef4444';
            }
            
            addLog('üìä Status checked');
        }

        async function sendDM() {
            const username = document.getElementById('dmUsername').value;
            const message = document.getElementById('dmMessage').value;
            
            if (!username || !message) {
                alert('Please fill in both username and message');
                return;
            }

            const loading = document.getElementById('loading2');
            loading.classList.add('active');
            addLog(`üì© Sending DM to @${username}...`);
            
            const result = await apiCall('/api/dm', 'POST', { username, message });
            
            loading.classList.remove('active');
            if (result.error) {
                addLog('‚ùå Error: ' + result.error);
            } else {
                addLog(`‚úÖ DM sent to @${username}`);
                document.getElementById('dmUsername').value = '';
                document.getElementById('dmMessage').value = '';
            }
        }

        async function watchStories() {
            const count = parseInt(document.getElementById('storyCount').value, 10);
            const targetRaw = document.getElementById('storyTarget').value.trim();
            const likePercent = parseFloat(document.getElementById('storyLikeProbability').value);
            const reactionPercent = parseFloat(document.getElementById('storyReactionProbability').value);
            const reactionEmoji = document.getElementById('storyReactionEmoji').value.trim();
            const minWatch = parseFloat(document.getElementById('storyMinWatch').value);
            const maxWatch = parseFloat(document.getElementById('storyMaxWatch').value);

            const storyCount = Number.isNaN(count) ? 10 : Math.max(1, count);
            let minSeconds = Number.isNaN(minWatch) ? 5 : Math.max(2, minWatch);
            let maxSeconds = Number.isNaN(maxWatch) ? 9 : Math.max(3, maxWatch);
            if (maxSeconds < minSeconds) {
                [minSeconds, maxSeconds] = [maxSeconds, minSeconds];
            }

            const likeProbability = Number.isNaN(likePercent)
                ? 0.3
                : Math.min(1, Math.max(0, likePercent / 100));
            const reactionProbability = Number.isNaN(reactionPercent)
                ? 0.2
                : Math.min(1, Math.max(0, reactionPercent / 100));

            const payload = {
                storyCount,
                targetUsername: targetRaw.replace(/^@/, '') || undefined,
                likeProbability,
                reactionProbability,
                reactionEmoji,
                minWatchTimeMs: Math.round(minSeconds * 1000),
                maxWatchTimeMs: Math.round(maxSeconds * 1000),
            };

            const loading = document.getElementById('loadingStories');
            loading.classList.add('active');
            addLog(`üëÅÔ∏è Watching ${storyCount} stories${payload.targetUsername ? ' from @' + payload.targetUsername : ''}...`);

            const result = await apiCall('/api/stories/watch', 'POST', payload);
            loading.classList.remove('active');

            if (result.error) {
                addLog('‚ùå Error: ' + result.error);
            } else {
                addLog('‚úÖ ' + result.message);
            }
        }

        async function scrapeFollowers() {
            const targetAccount = document.getElementById('targetAccount').value;
            const maxFollowers = parseInt(document.getElementById('maxFollowers').value);
            
            if (!targetAccount) {
                alert('Please enter a target account');
                return;
            }

            const loading = document.getElementById('loading3');
            loading.classList.add('active');
            addLog(`üë• Scraping followers from @${targetAccount}...`);
            
            const result = await apiCall('/api/scrape-followers', 'POST', { 
                targetAccount, 
                maxFollowers 
            });
            
            loading.classList.remove('active');
            if (result.error) {
                addLog('‚ùå Error: ' + result.error);
            } else {
                addLog(`‚úÖ Scraped ${result.followers?.length || 0} followers`);
                if (result.followers && result.followers.length > 0) {
                    addLog(`First 5: ${result.followers.slice(0, 5).join(', ')}`);
                }
            }
        }

        async function monitorDMs() {
            const loading = document.getElementById('loading4');
            loading.classList.add('active');
            addLog('üì¨ Monitoring DMs and auto-replying...');
            
            const result = await apiCall('/api/monitor-dms', 'POST');
            
            loading.classList.remove('active');
            if (result.error) {
                addLog('‚ùå Error: ' + result.error);
            } else {
                addLog('‚úÖ ' + result.message);
            }
        }

        async function checkScheduler() {
            const loading = document.getElementById('loading4');
            loading.classList.add('active');
            addLog('‚è∞ Checking scheduler status...');
            
            const result = await apiCall('/api/scheduler/status');
            
            loading.classList.remove('active');
            if (result.error) {
                addLog('‚ùå Error: ' + result.error);
            } else {
                addLog(`‚è∞ Scheduler running: ${result.isRunning ? 'Yes ‚úÖ' : 'No ‚ùå'}`);
                if (result.morningNextRun) {
                    addLog(`  Morning job: ${new Date(result.morningNextRun).toLocaleString()}`);
                }
            }
        }

        async function getMyProfile() {
            const loading = document.getElementById('loading4');
            loading.classList.add('active');
            addLog('üë§ Fetching profile info...');
            
            const result = await apiCall('/api/me');
            
            loading.classList.remove('active');
            if (result.error) {
                addLog('‚ùå Error: ' + result.error);
            } else {
                addLog(`üë§ Username: ${result.username || 'Unknown'}`);
            }
        }

        async function saveProxySettings() {
            const enabled = document.getElementById('proxyEnabled').checked;
            const host = document.getElementById('proxyHost').value;
            const port = document.getElementById('proxyPort').value;
            const username = document.getElementById('proxyUsername').value;
            const password = document.getElementById('proxyPassword').value;
            
            const loading = document.getElementById('loading5');
            const statusDiv = document.getElementById('proxyStatus');
            
            loading.classList.add('active');
            statusDiv.textContent = 'üíæ Saving proxy settings...';
            addLog(`üíæ Saving proxy settings...`);
            
            // Send to API
            const result = await apiCall('/api/proxy/settings', 'POST', {
                enabled,
                host,
                port,
                username,
                password
            });
            
            loading.classList.remove('active');
            
            if (result.error) {
                statusDiv.textContent = '‚ùå Failed to save: ' + result.error;
                statusDiv.style.color = '#ef4444';
                addLog('‚ùå Error: ' + result.error);
            } else {
                // Also save to localStorage as backup
                localStorage.setItem('proxyConfig', JSON.stringify({enabled, host, port, username, password}));
                
                if (enabled && host && port) {
                    statusDiv.textContent = `‚úÖ Saved: ${host}:${port} - Restart bot to apply`;
                    statusDiv.style.color = '#10b981';
                    addLog(`‚úÖ Proxy settings saved to server: ${host}:${port}`);
                    addLog('‚ö†Ô∏è IMPORTANT: Restart the bot for changes to take effect!');
                } else if (enabled) {
                    statusDiv.textContent = '‚ö†Ô∏è Proxy enabled but host/port missing';
                    statusDiv.style.color = '#f59e0b';
                } else {
                    statusDiv.textContent = 'üì° Proxy disabled - Restart bot to apply';
                    statusDiv.style.color = '#6b7280';
                    addLog('üì° Proxy disabled');
                }
            }
        }

        async function testProxy() {
            const loading = document.getElementById('loading5');
            const statusDiv = document.getElementById('proxyStatus');
            const host = document.getElementById('proxyHost').value;
            const port = document.getElementById('proxyPort').value;
            const username = document.getElementById('proxyUsername').value;
            const password = document.getElementById('proxyPassword').value;
            
            if (!host || !port) {
                alert('Please enter proxy host and port first');
                return;
            }
            
            loading.classList.add('active');
            statusDiv.textContent = 'üß™ Testing proxy connection...';
            addLog(`üß™ Testing proxy: ${host}:${port}...`);
            
            // Call API to test proxy
            const result = await apiCall('/api/proxy/test', 'POST', {
                host,
                port,
                username,
                password
            });
            
            loading.classList.remove('active');
            
            if (result.success) {
                statusDiv.textContent = `‚úÖ Proxy working! IP: ${result.proxyIp || 'Unknown'}`;
                statusDiv.style.color = '#10b981';
                addLog(`‚úÖ Proxy test successful! Proxy IP: ${result.proxyIp || 'Unknown'}`);
                addLog('üí° Tip: Save settings and restart bot to use this proxy');
            } else {
                statusDiv.textContent = `‚ùå Proxy test failed: ${result.error}`;
                statusDiv.style.color = '#ef4444';
                addLog(`‚ùå Proxy test failed: ${result.error}`);
            }
        }

        async function loadProxySettings() {
            // Try to load from API first
            const result = await apiCall('/api/proxy/settings');
            
            if (result && !result.error) {
                document.getElementById('proxyEnabled').checked = result.enabled || false;
                document.getElementById('proxyHost').value = result.host || '';
                document.getElementById('proxyPort').value = result.port || '';
                
                const statusDiv = document.getElementById('proxyStatus');
                if (result.enabled && result.host && result.port) {
                    statusDiv.textContent = `‚úÖ Active: ${result.host}:${result.port}`;
                    statusDiv.style.color = '#10b981';
                    addLog(`üîí Proxy loaded: ${result.host}:${result.port}`);
                } else {
                    statusDiv.textContent = 'üì° No proxy configured';
                    statusDiv.style.color = '#6b7280';
                }
                return;
            }
            
            // Fallback to localStorage
            const saved = localStorage.getItem('proxyConfig');
            if (saved) {
                try {
                    const config = JSON.parse(saved);
                    document.getElementById('proxyEnabled').checked = config.enabled || false;
                    document.getElementById('proxyHost').value = config.host || '';
                    document.getElementById('proxyPort').value = config.port || '';
                    document.getElementById('proxyUsername').value = config.username || '';
                    document.getElementById('proxyPassword').value = config.password || '';
                    
                    const statusDiv = document.getElementById('proxyStatus');
                    if (config.enabled && config.host && config.port) {
                        statusDiv.textContent = `üíæ Cached: ${config.host}:${config.port}`;
                        statusDiv.style.color = '#6b7280';
                    }
                } catch (e) {
                    console.error('Error loading proxy settings:', e);
                }
            }
        }

        async function viewLogs() {
            const loading = document.getElementById('loading4');
            loading.classList.add('active');
            addLog('üìã Fetching recent logs...');
            
            const result = await apiCall('/api/logs/recent?lines=60');
            loading.classList.remove('active');
            
            if (result.error) {
                addLog('‚ùå Error: ' + result.error);
                return;
            }
            
            const logs = document.getElementById('logs');
            const lines = Array.isArray(result.lines) ? result.lines : [];
            logs.textContent = lines.length ? lines.join('\n') : 'No log entries available.';
            logs.scrollTop = logs.scrollHeight;
            addLog('‚úÖ Logs updated');
        }

        // Auto-refresh status every 30 seconds
        setInterval(() => {
            checkStatus();
        }, 30000);

        // Auto-check status on load
        window.onload = () => {
            checkStatus();
            loadProxySettings(); // Load saved proxy settings
            updateInteractionFields();
            addLog('ü§ñ Dashboard loaded');
            addLog('üí° Tip: You can control the bot from anywhere!');
        };
    </script>
</body>
</html>

