<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instagram Bot Dashboard - Marketing Team App</title>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --dark: #1f2937;
            --light: #f9fafb;
            --border: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f3f4f6;
            min-height: 100vh;
            padding: 0;
            color: var(--dark);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        /* Jarvee-style shell */
        .app-shell {
            display: grid;
            grid-template-columns: 240px 1fr 340px;
            min-height: 100vh;
        }

        .sidebar {
            position: sticky;
            top: 0;
            height: 100vh;
            background: linear-gradient(180deg, #c2410c 0%, #9a3412 100%);
            color: white;
            padding: 18px 14px;
            border-right: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar .brand {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 10px 16px 10px;
            margin-bottom: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.15);
        }

        .brand-badge {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.15);
            font-size: 20px;
        }

        .brand-title {
            font-weight: 800;
            letter-spacing: 0.2px;
            line-height: 1.1;
        }

        .brand-subtitle {
            font-size: 12px;
            opacity: 0.85;
            margin-top: 2px;
        }

        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 10px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 12px;
            color: rgba(255,255,255,0.92);
            text-decoration: none;
            font-weight: 700;
            font-size: 14px;
            transition: background 0.2s ease, transform 0.2s ease;
        }

        .nav-link:hover {
            background: rgba(255,255,255,0.14);
            transform: translateX(2px);
        }

        .nav-icon {
            width: 28px;
            height: 28px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.12);
            font-size: 14px;
        }

        .main {
            min-width: 0;
        }

        .rightbar {
            position: sticky;
            top: 0;
            height: 100vh;
            padding: 24px 18px;
            border-left: 1px solid var(--border);
            background: #fafafa;
            overflow: auto;
        }

        .rail-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 14px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.04);
            margin-bottom: 14px;
        }

        .rail-title {
            font-weight: 800;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .rail-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 260px;
            overflow: auto;
        }

        .rail-item {
            font-size: 13px;
            padding: 10px 10px;
            border-radius: 12px;
            background: #f9fafb;
            border: 1px solid #eef2f7;
            color: #111827;
            line-height: 1.25;
        }

        .rail-item small {
            display: block;
            opacity: 0.75;
            margin-top: 3px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Compact header for the shell */
        .header {
            margin-top: 24px;
        }

        @media (max-width: 1100px) {
            .app-shell {
                grid-template-columns: 220px 1fr;
            }
            .rightbar {
                display: none;
            }
        }

        @media (max-width: 820px) {
            .app-shell {
                grid-template-columns: 1fr;
            }
            .sidebar {
                position: relative;
                height: auto;
            }
            .container {
                padding: 18px;
            }
        }
        
        /* Header */
        .header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .header h1 {
            font-size: 2em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 600;
            background: var(--light);
            border: 2px solid var(--border);
        }
        
        .status-badge.online {
            background: #d1fae5;
            border-color: var(--success);
            color: var(--success);
        }
        
        .status-badge.offline {
            background: #fee2e2;
            border-color: var(--danger);
            color: var(--danger);
        }

        /* System Overview pills */
        .pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: #f9fafb;
            color: #111827;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .pulse {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Grid Layout */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        }
        
        /* Cards */
        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: var(--shadow);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light);
        }
        
        .card-icon {
            font-size: 28px;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            color: white;
        }
        
        .card h2 {
            font-size: 1.3em;
            color: var(--dark);
            flex: 1;
        }
        
        /* Form Elements */
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--dark);
            font-size: 14px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s;
            font-family: inherit;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        /* Buttons */
        button {
            width: 100%;
            padding: 14px 20px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 10px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-info {
            background: var(--info);
            color: white;
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        /* Checkbox */
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: var(--light);
            border-radius: 10px;
            cursor: pointer;
            margin: 10px 0;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: auto;
            cursor: pointer;
        }
        
        /* Status Messages */
        .status-message {
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-message.success {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-message.error {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .status-message.info {
            background: #dbeafe;
            color: #1e40af;
        }
        
        /* Loading Spinner */
        .loading {
            display: none;
            text-align: center;
            padding: 15px;
            color: var(--primary);
            font-weight: 600;
        }
        
        .loading.active {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid var(--light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Logs */
        .log-container {
            background: var(--dark);
            color: #d1d5db;
            padding: 20px;
            border-radius: 10px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
        }

        .ai-chat-log {
            background: #0f172a;
            color: #e5e7eb;
            border-radius: 12px;
            padding: 14px;
            height: 260px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
            border: 1px solid #1f2937;
        }

        .ai-chat-bubble {
            padding: 10px 12px;
            border-radius: 10px;
            line-height: 1.4;
            font-size: 0.95rem;
            box-shadow: 0 6px 18px rgba(15, 23, 42, 0.25);
        }

        .ai-chat-bubble.user {
            background: #eef2ff;
            color: #1f2937;
            align-self: flex-end;
        }

        .ai-chat-bubble.assistant {
            background: #111827;
            color: #e5e7eb;
            border: 1px solid #1f2937;
        }

        .ai-chat-input {
            display: flex;
            gap: 12px;
            margin-top: 14px;
            align-items: stretch;
        }

        .ai-chat-input input {
            flex: 1;
            width: auto; /* override global input width:100% inside flex */
            min-width: 0; /* allow flexbox to size correctly */
            padding: 12px;
            border-radius: 10px;
            border: 1px solid #d1d5db;
            font-size: 0.95rem;
        }

        /* Fix: global `button { width: 100%; }` breaks the chat input row */
        .ai-chat-input button {
            width: auto;
            flex: 0 0 auto;
            margin-top: 0;
            padding: 12px 18px;
            border-radius: 10px;
        }

        .ai-log-snippet {
            margin-top: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.06);
            border-radius: 8px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.8rem;
            color: #cbd5f5;
        }
        
        .log-entry {
            padding: 8px 12px;
            margin-bottom: 4px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.05);
            border-left: 3px solid #6b7280;
        }
        
        .log-entry.log-success {
            color: #10b981;
            border-left-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }
        
        .log-entry.log-error {
            color: #ef4444;
            border-left-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }
        
        .log-entry.log-warning {
            color: #f59e0b;
            border-left-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }
        
        .log-entry.log-info {
            color: #3b82f6;
            border-left-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }
        
        .log-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .log-container::-webkit-scrollbar-track {
            background: #374151;
            border-radius: 10px;
        }
        
        .log-container::-webkit-scrollbar-thumb {
            background: #6b7280;
            border-radius: 10px;
        }
        
        /* Collapsible Sections */
        .collapsible {
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: var(--light);
            border-radius: 10px;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .collapsible:hover {
            background: #e5e7eb;
        }
        
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .collapsible-content.active {
            max-height: 1000px;
        }
        
        .arrow {
            transition: transform 0.3s;
        }
        
        .arrow.active {
            transform: rotate(180deg);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
            }
            
            .grid {
                grid-template-columns: 1fr;
            }
            
            .grid-2 {
                grid-template-columns: 1fr;
            }
        }
        
        /* Utility Classes */
        .mt-2 { margin-top: 10px; }
        .mb-2 { margin-bottom: 10px; }
        .text-center { text-align: center; }
        .flex { display: flex; }
        .gap-2 { gap: 10px; }
        .hidden { display: none; }
        .card-divider {
            width: 100%;
            height: 1px;
            background: var(--border);
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="app-shell">
        <aside class="sidebar">
            <div class="brand">
                <div class="brand-badge">ü§ñ</div>
                <div>
                    <div class="brand-title">Marketing Team</div>
                    <div class="brand-subtitle">Lead Gen Copilot</div>
                </div>
            </div>
            <nav class="sidebar-nav">
                <a class="nav-link" href="#section-account"><span class="nav-icon">üîê</span>Account</a>
                <a class="nav-link" href="#section-proxy"><span class="nav-icon">üåê</span>Proxy</a>
                <a class="nav-link" href="#section-leads"><span class="nav-icon">‚ö°</span>Lead Gen</a>
                <a class="nav-link" href="#section-stories"><span class="nav-icon">üì∫</span>Stories</a>
                <a class="nav-link" href="#section-dms"><span class="nav-icon">üí¨</span>DMs</a>
                <a class="nav-link" href="#section-tools"><span class="nav-icon">üõ†Ô∏è</span>Tools</a>
                <a class="nav-link" href="#section-scheduler"><span class="nav-icon">‚è∞</span>Scheduler</a>
                <a class="nav-link" href="#section-ai"><span class="nav-icon">ü§ñ</span>AI Console</a>
                <a class="nav-link" href="#section-logs"><span class="nav-icon">üìú</span>Logs</a>
                <a class="nav-link" href="#section-screens"><span class="nav-icon">üì∏</span>Screens</a>
            </nav>
        </aside>

        <main class="main">
            <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>
                <span>ü§ñ</span>
                Instagram Lead Gen Copilot
            </h1>
            <div id="statusBadge" class="status-badge offline">
                <div class="pulse"></div>
                <span>Checking...</span>
            </div>
        </div>
        <div id="systemOverview" style="display:flex;flex-wrap:wrap;gap:8px;margin:10px 0 16px 0;">
            <span class="pill" id="pillServerTime">‚è±Ô∏è Server: ‚Ä¶</span>
            <span class="pill" id="pillUptime">üß† Uptime: ‚Ä¶</span>
            <span class="pill" id="pillToday">üìä Today: ‚Ä¶</span>
            <span class="pill" id="pillDb">üóÑÔ∏è DB: ‚Ä¶</span>
            <span class="pill" id="pillProxy">üåê Proxy: ‚Ä¶</span>
            <span class="pill" id="pillAi">ü§ñ Gemini: ‚Ä¶</span>
            <span class="pill" id="pillIgSession">üì± IG: ‚Ä¶</span>
            <span class="pill" id="pillAuth">üîê Dashboard: ‚Ä¶</span>
        </div>
        
        <!-- Main Grid -->
        <div class="grid">
            <!-- Account Control -->
            <div class="card" id="section-account">
                <div class="card-header">
                    <div class="card-icon">üîê</div>
                    <h2>Account</h2>
                </div>
                
                <!-- Login Form (shown when logged out) -->
                <div id="loginForm">
                    <div class="form-group">
                        <label>Instagram Username</label>
                        <input type="text" id="loginUsername" placeholder="your_username">
                    </div>
                    <div class="form-group">
                        <label>Instagram Password</label>
                        <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="rememberMeCheckbox" checked>
                        <label style="margin: 0;">Remember me for 30 days</label>
                    </div>
                    <button class="btn-success" onclick="login()">üîì Login</button>
                </div>
                
                <!-- Logged In Controls (shown when logged in) -->
                <div id="loggedInControls" class="hidden">
                    <button class="btn-danger" onclick="logout()">üö™ Logout</button>
                    <button class="btn-secondary" onclick="clearCookies()">üßπ Clear Cookies</button>
                    <div class="card-divider"></div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="igKeepAliveToggle" checked>
                        <label style="margin: 0;">Keep IG session warm (auto-refresh)</label>
                    </div>
                    <div class="form-group" style="margin-top: 10px;">
                        <label>Keep-alive interval</label>
                        <select id="igKeepAliveInterval">
                            <option value="15">Every 15 minutes</option>
                            <option value="30" selected>Every 30 minutes</option>
                            <option value="60">Every 60 minutes</option>
                            <option value="120">Every 2 hours</option>
                        </select>
                        <small style="display:block;color:#6b7280;margin-top:4px;">Will skip if a scheduled task is actively running.</small>
                    </div>
                    <button class="btn-info" onclick="refreshIgSessionNow()">üîÑ Refresh IG Session Now</button>
                </div>
                
                <div class="loading" id="loadingLogin">
                    <div class="spinner"></div>
                    <span>Processing...</span>
                </div>
                <div id="loginStatus" class="status-message info mt-2">
                    ‚ÑπÔ∏è Checking status...
                </div>
            </div>
            
            <!-- Proxy Configuration -->
            <div class="card" id="section-proxy">
                <div class="card-header">
                    <div class="card-icon">üåê</div>
                    <h2>Proxy Settings</h2>
                </div>
                <div class="status-message info mb-2">
                    ‚ÑπÔ∏è Using a proxy helps avoid Instagram rate limits and IP blocks
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="proxyEnabled">
                    <label style="margin: 0;">Enable Proxy</label>
                </div>
                <div id="proxyFields" class="hidden">
                    <div class="form-group">
                        <label>Proxy Host</label>
                        <input type="text" id="proxyHost" placeholder="proxy.example.com">
                    </div>
                    <div class="form-group">
                        <label>Proxy Port</label>
                        <input type="number" id="proxyPort" placeholder="8080">
                    </div>
                    <div class="form-group">
                        <label>Proxy Username (optional)</label>
                        <input type="text" id="proxyUsername" placeholder="username">
                    </div>
                    <div class="form-group">
                        <label>Proxy Password (optional)</label>
                        <input type="password" id="proxyPassword" placeholder="password">
                    </div>
                    <button class="btn-primary" onclick="saveProxySettings()">üíæ Save Proxy Settings</button>
                </div>
                <div class="loading hidden" id="loadingProxy">
                    <div class="spinner"></div>
                    <span>Saving...</span>
                </div>
                <div id="proxyStatus" class="status-message info mt-2 hidden">
                    ‚ÑπÔ∏è Proxy status
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="card" id="section-leads">
                <div class="card-header">
                    <div class="card-icon">‚ö°</div>
                    <h2>Lead Generation</h2>
                </div>
                <div class="form-group">
                    <label>Targeting Mode</label>
                    <select id="interactionMode" onchange="updateInteractionFields()">
                        <option value="feed">Recent Feed</option>
                        <option value="explore">Explore Page</option>
                        <option value="hashtag">Hashtag Search</option>
                        <option value="location">Location Search</option>
                        <option value="user">Specific User</option>
                        <option value="competitor_followers">Competitor Followers</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Max Posts to Process</label>
                    <input type="number" id="maxPostsInput" value="10" min="1" max="100">
                </div>
                
                <!-- Dynamic Fields -->
                <div id="targetUsernameGroup" class="form-group hidden">
                    <label>Target Username</label>
                    <input type="text" id="interactionTarget" placeholder="username (no @)">
                </div>
                <div id="hashtagGroup" class="form-group hidden">
                    <label>Hashtags (comma separated)</label>
                    <input type="text" id="interactionHashtags" placeholder="restaurant, miami, food">
                </div>
                <div id="locationGroup" class="form-group hidden">
                    <label>Location Path</label>
                    <input type="text" id="locationPath" placeholder="212941492/miami-florida">
                </div>
                <div id="competitorGroup" class="form-group hidden">
                    <label>Competitor Username</label>
                    <input type="text" id="competitorUsername" placeholder="competitor_username">
                </div>
                
                <!-- Advanced Options -->
                <div class="collapsible" onclick="toggleCollapsible('advancedOptions')">
                    <span>‚öôÔ∏è Advanced Filters</span>
                    <span class="arrow" id="advancedOptionsArrow">‚ñº</span>
                </div>
                <div id="advancedOptions" class="collapsible-content">
                    <div class="form-group">
                        <label>Min Likes (optional)</label>
                        <input type="number" id="minLikesInput" placeholder="e.g., 50">
                    </div>
                    <div class="form-group">
                        <label>Min Comments (optional)</label>
                        <input type="number" id="minCommentsInput" placeholder="e.g., 5">
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="englishOnlyCheckbox" checked>
                        <label style="margin: 0;">English captions only</label>
                    </div>
                </div>
                
                <button class="btn-primary" onclick="startCommenting()">üöÄ Start Campaign</button>
                <button class="btn-info" onclick="checkStatus()">üìä Check Status</button>
                <div class="loading" id="loading1">
                    <div class="spinner"></div>
                    <span>Running campaign...</span>
                </div>
            </div>
            
            <!-- Story Viewer -->
            <div class="card" id="section-stories">
                <div class="card-header">
                    <div class="card-icon">üì∫</div>
                    <h2>Story Engagement</h2>
                </div>
                <div class="form-group">
                    <label>Stories to Watch</label>
                    <input type="number" id="storyCount" value="10" min="1" max="50">
                </div>
                <div class="form-group">
                    <label>Target User (optional)</label>
                    <input type="text" id="storyTarget" placeholder="Leave empty for feed">
                </div>
                <div class="flex gap-2">
                    <div class="form-group" style="flex: 1;">
                        <label>Like % (0-100)</label>
                        <input type="number" id="storyLikeProbability" value="30" min="0" max="100">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>React % (0-100)</label>
                        <input type="number" id="storyReactionProbability" value="20" min="0" max="100">
                    </div>
                </div>
                <div class="form-group">
                    <label>Reaction Emoji</label>
                    <input type="text" id="storyReactionEmoji" value="üî•" maxlength="2">
                </div>
                <div class="flex gap-2">
                    <div class="form-group" style="flex: 1;">
                        <label>Min Watch (sec)</label>
                        <input type="number" id="storyMinWatch" value="5" min="2">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Max Watch (sec)</label>
                        <input type="number" id="storyMaxWatch" value="9" min="3">
                    </div>
                </div>
                <div class="card-divider"></div>
                <div class="checkbox-group">
                    <input type="checkbox" id="storyAiReplyEnabled">
                    <label style="margin: 0;">Enable AI story replies (Gemini-powered)</label>
                </div>
                <div id="storyAiOptions" class="hidden">
                    <div class="form-group">
                        <label>Max AI Replies per Session</label>
                        <input type="number" id="storyAiMaxReplies" value="3" min="1" max="20">
                    </div>
                    <div class="form-group">
                        <label>Reply Tone</label>
                        <select id="storyAiTone">
                            <option value="friendly">Friendly + warm</option>
                            <option value="consultative">Consultative / advisor</option>
                            <option value="hype">High-energy / hype</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Confidence Threshold (%)</label>
                        <input type="number" id="storyAiConfidence" value="55" min="10" max="100">
                        <small style="display:block;color:#6b7280;margin-top:4px;">Only reply when Gemini confidence exceeds this level.</small>
                    </div>
                </div>
                <button class="btn-primary" onclick="watchStories()">üëÅÔ∏è Watch Stories</button>
                <div class="loading" id="loadingStories">
                    <div class="spinner"></div>
                    <span>Watching stories...</span>
                </div>
            </div>
        </div>
        
        <!-- Second Row -->
        <div class="grid">
            <!-- DM Management -->
            <div class="card" id="section-dms">
                <div class="card-header">
                    <div class="card-icon">üí¨</div>
                    <h2>Direct Messages</h2>
                </div>
                <button class="btn-primary" onclick="monitorDMs()">üì¨ Monitor & Auto-Reply</button>
                <button class="btn-info" onclick="clearDMCache()">üóëÔ∏è Clear Reply Cache</button>
                <div class="collapsible mt-2" onclick="toggleCollapsible('dmAiSettingsSection')">
                    <span>ü§ñ AI DM Reply Settings</span>
                    <span class="arrow" id="dmAiSettingsSectionArrow">‚ñº</span>
                </div>
                <div id="dmAiSettingsSection" class="collapsible-content">
                    <div class="checkbox-group">
                        <input type="checkbox" id="dmAiEnabled" checked>
                        <label style="margin: 0;">Enable AI auto-replies</label>
                    </div>
                    <div class="form-group">
                        <label>Brand / Account Name</label>
                        <input type="text" id="dmAiBrandName" placeholder="e.g. MarketingTeam.app">
                    </div>
                    <div class="form-group">
                        <label>About this account (what you do)</label>
                        <textarea id="dmAiAbout" placeholder="Describe the business, niche, audience, what you help with..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Offer (what you sell / next step)</label>
                        <textarea id="dmAiOffer" placeholder="What you want to offer (call, link, free audit, etc)."></textarea>
                    </div>
                    <div class="flex gap-2">
                        <div class="form-group" style="flex: 1;">
                            <label>Tone</label>
                            <select id="dmAiTone">
                                <option value="friendly">Friendly</option>
                                <option value="professional">Professional</option>
                                <option value="consultative">Consultative</option>
                                <option value="playful">Playful</option>
                                <option value="hype">Hype</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label>CTA Style</label>
                            <select id="dmAiCtaStyle">
                                <option value="question">End with a question</option>
                                <option value="soft">Soft CTA</option>
                                <option value="direct">Direct CTA</option>
                                <option value="none">No CTA</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <div class="form-group" style="flex: 1;">
                            <label>Emoji Level</label>
                            <select id="dmAiEmojiLevel">
                                <option value="none">None</option>
                                <option value="low" selected>Low</option>
                                <option value="medium">Medium</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label>Max Sentences</label>
                            <input type="number" id="dmAiMaxSentences" value="2" min="1" max="4">
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <div class="form-group" style="flex: 1;">
                            <label>Max Characters</label>
                            <input type="number" id="dmAiMaxChars" value="260" min="80" max="600">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label>Signature (optional)</label>
                            <input type="text" id="dmAiSignature" placeholder="e.g. - Bobby">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Avoid Topics (one per line)</label>
                        <textarea id="dmAiAvoidTopics" placeholder="prices&#10;legal advice&#10;sensitive personal data"></textarea>
                    </div>
                    <div style="display:flex;gap:10px;flex-wrap:wrap;">
                        <button class="btn-success" onclick="saveDmAiSettings()">üíæ Save AI Settings</button>
                        <button class="btn-secondary" onclick="loadDmAiSettings()">‚Üª Reload</button>
                    </div>
                </div>
                <div class="collapsible mt-2" onclick="toggleCollapsible('sendDMSection')">
                    <span>üì© Send Manual DM</span>
                    <span class="arrow" id="sendDMSectionArrow">‚ñº</span>
                </div>
                <div id="sendDMSection" class="collapsible-content">
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="dmUsername" placeholder="username (no @)">
                    </div>
                    <div class="form-group">
                        <label>Message</label>
                        <textarea id="dmMessage" placeholder="Your message..."></textarea>
                    </div>
                    <button class="btn-success" onclick="sendDM()">Send DM</button>
                </div>
                <div class="loading" id="loading2">
                    <div class="spinner"></div>
                    <span>Processing DMs...</span>
                </div>
            </div>
            
            <!-- Advanced Tools -->
            <div class="card" id="section-tools">
                <div class="card-header">
                    <div class="card-icon">üõ†Ô∏è</div>
                    <h2>Tools</h2>
                </div>
                <button class="btn-info" onclick="viewLogs()">üìã View Recent Logs</button>
                <button id="liveLogBtn" class="btn-success" onclick="toggleLiveLog()">‚ñ∂Ô∏è Start Live Log</button>
                <button class="btn-info" onclick="checkScheduler()">‚è∞ Scheduler Status</button>
                <button class="btn-success" onclick="getMyProfile()">üë§ My Profile Info</button>
                <div class="collapsible mt-2" onclick="toggleCollapsible('scraperSection')">
                    <span>üë• Follower Scraper</span>
                    <span class="arrow" id="scraperSectionArrow">‚ñº</span>
                </div>
                <div id="scraperSection" class="collapsible-content">
                    <div class="form-group">
                        <label>Target Account</label>
                        <input type="text" id="targetAccount" placeholder="username">
                    </div>
                    <div class="form-group">
                        <label>Max Followers</label>
                        <input type="number" id="maxFollowers" value="50" min="1">
                    </div>
                    <button class="btn-info" onclick="scrapeFollowers()">Scrape Followers</button>
                </div>
                <div class="loading" id="loading4">
                    <div class="spinner"></div>
                    <span>Processing...</span>
                </div>
            </div>
        </div>

        <!-- Task Scheduler -->
        <div class="grid" id="section-scheduler">
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">‚è∞</div>
                    <h2>Task Scheduler</h2>
                </div>
                <div id="serverTimeBar" style="display:flex;gap:10px;align-items:center;justify-content:space-between;margin: 0 0 10px 0; padding: 10px 12px; border: 1px solid #e5e7eb; border-radius: 10px; background: #f9fafb;">
                    <div style="font-size: 12px; color:#374151;">
                        <strong>Server Time</strong>: <span id="serverTimeValue">Loading...</span>
                        <span style="margin-left:8px;color:#6b7280;">(<span id="serverTzValue">...</span>)</span>
                    </div>
                    <div style="font-size: 12px; color:#6b7280;">
                        <strong>Your Time</strong>: <span id="localTimeValue">--:--:--</span>
                    </div>
                </div>
                <div class="mb-2">
                    <button class="btn-primary" onclick="showCreateTaskModal()">‚ûï Create Scheduled Task</button>
                    <button class="btn-info" onclick="loadScheduledTasks()">üîÑ Refresh</button>
                </div>
                <div style="display:flex;gap:8px;flex-wrap:wrap;margin: 0 0 12px 0;">
                    <button class="btn-secondary" style="width:auto;padding:8px 10px;font-size:12px;" onclick="showCreateTaskModal({ preset: 'hourly_stories' })">‚ö° Hourly Stories</button>
                    <button class="btn-secondary" style="width:auto;padding:8px 10px;font-size:12px;" onclick="showCreateTaskModal({ preset: 'hourly_campaign' })">‚ö° Hourly Campaign</button>
                    <button class="btn-secondary" style="width:auto;padding:8px 10px;font-size:12px;" onclick="showCreateTaskModal({ preset: 'dm_15m' })">‚ö° DM Monitor (15m)</button>
                </div>
                <div id="scheduledTasksList" style="max-height: 400px; overflow-y: auto;">
                    <p style="text-align: center; color: #6b7280;">Loading scheduled tasks...</p>
                </div>
            </div>
        </div>
        
        <!-- AI Command Console -->
        <div class="grid" id="section-ai">
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">ü§ñ</div>
                    <h2>AI Command Console</h2>
                </div>
                <div class="ai-chat-log" id="aiChatLog">
                    <div class="ai-chat-bubble assistant">
                        üëã Hi! I'm your automation copilot. Try asking me to run a Miami campaign, watch stories, or show the latest logs.
                    </div>
                </div>
                <div class="ai-chat-input">
                    <input type="text" id="aiCommandInput" placeholder="e.g. Run the Miami location campaign with 5 DMs">
                    <button class="btn-primary" onclick="sendAiCommand()">Send</button>
                </div>
                <div class="loading" id="aiChatLoading">
                    <div class="spinner"></div>
                    <span>Thinking...</span>
                </div>
            </div>
        </div>
        
        <!-- Logs and Screenshots Section -->
        <div class="grid grid-2">
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">üìú</div>
                    <h2>Activity Logs <span id="logCount" style="font-size: 14px; color: #667eea; font-weight: normal;"></span></h2>
                </div>
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <button class="btn-primary" id="liveLogBtn" onclick="toggleLiveLog()">‚ñ∂Ô∏è Start Live Log</button>
                    <select id="logDetailLevel" onchange="viewLogs()" style="padding: 8px; border-radius: 8px; border: 1px solid #e5e7eb;">
                        <option value="all">All Logs (Detailed)</option>
                        <option value="important">Important Only</option>
                    </select>
                </div>
                <div class="log-container" id="logs">
                    <!-- Logs will appear here with newest at top -->
                </div>
            </div>
            
            <div class="card" id="section-screens">
                <div class="card-header">
                    <div class="card-icon">üì∏</div>
                    <h2>Screenshot Viewer</h2>
                </div>
                <button class="btn-primary" onclick="loadScreenshots()">üîÑ Refresh Screenshots</button>
                <div id="screenshotGallery" style="margin-top: 15px; max-height: 400px; overflow-y: auto;">
                    <p style="text-align: center; color: #6b7280;">Click refresh to load recent screenshots</p>
                </div>
            </div>
        </div>
            </div>
        </main>

        <aside class="rightbar">
            <div class="rail-card">
                <div class="rail-title">
                    <span>Viewed Stories</span>
                    <button class="btn-info" style="width:auto;padding:8px 10px;margin:0;font-size:12px;" onclick="refreshRightRail()">‚Üª</button>
                </div>
                <div class="rail-list" id="railStories">
                    <div class="rail-item">No data yet<small>Run a story session to populate this.</small></div>
                </div>
            </div>
            <div class="rail-card">
                <div class="rail-title"><span>Recent Likes / Comments</span></div>
                <div class="rail-list" id="railCampaign">
                    <div class="rail-item">No data yet<small>Start a campaign to populate this.</small></div>
                </div>
            </div>
            <div class="rail-card">
                <div class="rail-title"><span>DM Activity</span></div>
                <div class="rail-list" id="railDMs">
                    <div class="rail-item">No data yet<small>Monitor DMs to populate this.</small></div>
                </div>
            </div>
            <div class="rail-card">
                <div class="rail-title"><span>Latest Errors</span></div>
                <div class="rail-list" id="railErrors">
                    <div class="rail-item">No errors seen<small>Great ‚Äî keep it up.</small></div>
                </div>
            </div>
        </aside>
    </div>

    <script>
        const API_URL = window.location.origin;

        const aiChatHistory = [];
        let schedulerLoaded = false;
        let systemOverviewInterval = null;
        let igKeepAliveIntervalHandle = null;
        let lastIgKeepAliveAttemptAt = 0;
        // Cache scheduler tasks so we can edit them without embedding JSON in onclick handlers
        window.__scheduledTasksById = window.__scheduledTasksById || {};

        // Lightweight status pills (no heavy UI framework required)
        function setPill(id, text, variant = 'neutral') {
            const el = document.getElementById(id);
            if (!el) return;
            el.textContent = text;
            el.style.borderColor = '#e5e7eb';
            el.style.background = '#f9fafb';
            el.style.color = '#111827';
            if (variant === 'ok') {
                el.style.borderColor = '#bbf7d0';
                el.style.background = '#f0fdf4';
                el.style.color = '#166534';
            } else if (variant === 'warn') {
                el.style.borderColor = '#fde68a';
                el.style.background = '#fffbeb';
                el.style.color = '#92400e';
            } else if (variant === 'bad') {
                el.style.borderColor = '#fecaca';
                el.style.background = '#fef2f2';
                el.style.color = '#991b1b';
            }
        }

        async function apiCall(endpoint, method = 'GET', body = null) {
            try {
                const options = {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include'
                };
                if (body) options.body = JSON.stringify(body);
                
                const response = await fetch(`${API_URL}${endpoint}`, options);
                const contentType = response.headers.get('content-type') || '';
                const isJson = contentType.includes('application/json');

                if (isJson) {
                    const data = await response.json();
                    if (!response.ok && !data?.error) {
                        return { error: `HTTP ${response.status} ${response.statusText}` };
                    }
                    return data;
                }

                // Non-JSON responses happen when nginx returns an HTML error page (502/504/etc).
                const text = await response.text();
                const snippet = text ? text.slice(0, 200).replace(/\s+/g, ' ').trim() : '';
                return { error: `HTTP ${response.status} ${response.statusText}${snippet ? `: ${snippet}` : ''}` };
            } catch (error) {
                console.error('API Error:', error);
                return { error: error.message };
            }
        }

        // Right rail: quick summaries pulled from server logs (public endpoint)
        async function refreshRightRail() {
            try {
                const result = await apiCall('/api/logs/recent?lines=250');
                const logs = Array.isArray(result.logs) ? result.logs : [];

                const pick = (predicate, max = 12) => {
                    const out = [];
                    for (const item of logs) {
                        const msg = typeof item?.message === 'string' ? item.message : '';
                        if (!msg) continue;
                        if (predicate(item, msg)) out.push({ item, msg });
                        if (out.length >= max) break;
                    }
                    return out;
                };

                const setList = (id, items, emptyText) => {
                    const el = document.getElementById(id);
                    if (!el) return;
                    if (!items.length) {
                        el.innerHTML = `<div class="rail-item">${emptyText}</div>`;
                        return;
                    }
                    el.innerHTML = items
                        .map(({ item, msg }) => {
                            // The server log timestamp is often a time-only string (e.g. "3:39:25 AM"),
                            // which `new Date()` treats as invalid. Prefer showing the raw string.
                            const rawTs = typeof item.timestamp === 'string' ? item.timestamp : '';
                            const d = rawTs ? new Date(rawTs) : null;
                            const ts = rawTs
                                ? (d && !Number.isNaN(d.getTime()) ? d.toLocaleTimeString() : rawTs)
                                : '';
                            const safe = (msg || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                            return `<div class="rail-item">${safe}<small>${ts}</small></div>`;
                        })
                        .join('');
                };

                setList(
                    'railStories',
                    pick((item, msg) => (item.category === 'story') || msg.toLowerCase().includes('story'), 10),
                    'No story activity yet.'
                );
                setList(
                    'railCampaign',
                    pick((item, msg) => (item.category === 'campaign') || msg.toLowerCase().includes('comment') || msg.toLowerCase().includes('like'), 10),
                    'No campaign activity yet.'
                );
                setList(
                    'railDMs',
                    pick((item, msg) => (item.category === 'dm') || msg.toLowerCase().includes(' dm'), 10),
                    'No DM activity yet.'
                );
                setList(
                    'railErrors',
                    pick((item) => item.level === 'error', 10),
                    'No errors in recent logs.'
                );
            } catch (e) {
                // Fail silently; this is secondary UI.
            }
        }

        function addLog(message) {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            
            // Determine log type based on message content for color coding
            let logClass = '';
            if (message.includes('‚úÖ') || message.includes('Success')) {
                logClass = 'log-success';
            } else if (message.includes('‚ùå') || message.includes('Error') || message.includes('Failed')) {
                logClass = 'log-error';
            } else if (message.includes('‚ö†Ô∏è') || message.includes('Warning')) {
                logClass = 'log-warning';
            } else if (message.includes('üöÄ') || message.includes('Starting')) {
                logClass = 'log-info';
            }
            
            // Create log entry and prepend (newest at top)
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${logClass}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            // Insert at the beginning instead of appending
            if (logs.firstChild) {
                logs.insertBefore(logEntry, logs.firstChild);
            } else {
                logs.appendChild(logEntry);
            }
            
            // Keep only last 100 log entries to prevent memory issues
            while (logs.children.length > 100) {
                logs.removeChild(logs.lastChild);
            }
        }

        function appendAiMessage(role, text) {
            const container = document.getElementById('aiChatLog');
            if (!container) return;
            const bubble = document.createElement('div');
            bubble.className = `ai-chat-bubble ${role}`;
            bubble.innerHTML = text.replace(/\n/g, '<br>');
            container.appendChild(bubble);
            container.scrollTop = container.scrollHeight;
        }

        function toggleAiChatLoading(active) {
            const loading = document.getElementById('aiChatLoading');
            if (!loading) return;
            loading.classList.toggle('active', !!active);
        }

        async function sendAiCommand() {
            const input = document.getElementById('aiCommandInput');
            if (!input) return;
            const message = input.value.trim();
            if (!message.length) return;

            appendAiMessage('user', message);
            aiChatHistory.push({ role: 'user', content: message });
            input.value = '';
            toggleAiChatLoading(true);

            const payload = {
                message,
                history: aiChatHistory.slice(-6),
            };

            const result = await apiCall('/api/ai/command', 'POST', payload);
            toggleAiChatLoading(false);

            if (result.error) {
                appendAiMessage('assistant', `‚ùå ${result.error}`);
                aiChatHistory.push({ role: 'assistant', content: `Error: ${result.error}` });
                return;
            }

            const plan = result.plan || {};
            const execution = result.execution || {};
            const confidencePct = plan.confidence ? Math.round(plan.confidence * 100) : 0;
            const summaryLine = plan.summary
                ? `üß† ${plan.summary} (${confidencePct}% confidence)`
                : 'üß† Command interpreted.';
            const executionLine = execution.message
                ? `${execution.success ? '‚úÖ' : '‚ö†Ô∏è'} ${execution.message}`
                : 'No follow-up action was executed.';

            let detailsBlock = '';
            if (execution.details?.logs) {
                const snippet = execution.details.logs.slice(-5).join('<br>');
                detailsBlock = `<div class="ai-log-snippet">${snippet}</div>`;
            } else if (execution.details?.help) {
                detailsBlock = `<div class="ai-log-snippet">${execution.details.help.replace(/\n/g, '<br>')}</div>`;
            } else if (execution.details) {
                detailsBlock = `<div class="ai-log-snippet">${JSON.stringify(execution.details, null, 2)}</div>`;
            }

            appendAiMessage('assistant', `${summaryLine}<br>${executionLine}${detailsBlock ? `<br>${detailsBlock}` : ''}`);
            aiChatHistory.push({
                role: 'assistant',
                content: `${summaryLine}\n${executionLine}`,
            });
        }

        function toggleCollapsible(id) {
            const content = document.getElementById(id);
            const arrow = document.getElementById(id + 'Arrow');
            content.classList.toggle('active');
            arrow.classList.toggle('active');
        }

        function updateInteractionFields() {
            const mode = document.getElementById('interactionMode').value;
            document.getElementById('targetUsernameGroup').classList.toggle('hidden', mode !== 'user');
            document.getElementById('hashtagGroup').classList.toggle('hidden', mode !== 'hashtag');
            document.getElementById('locationGroup').classList.toggle('hidden', mode !== 'location');
            document.getElementById('competitorGroup').classList.toggle('hidden', mode !== 'competitor_followers');
        }

        function toggleStoryAiOptions() {
            const enabled = document.getElementById('storyAiReplyEnabled').checked;
            document.getElementById('storyAiOptions').classList.toggle('hidden', !enabled);
        }

        async function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const rememberMe = document.getElementById('rememberMeCheckbox').checked;
            
            if (!username || !password) {
                alert('Please enter both username and password');
                return;
            }

            const loading = document.getElementById('loadingLogin');
            const statusDiv = document.getElementById('loginStatus');
            loading.classList.add('active');
            statusDiv.className = 'status-message info mt-2';
            statusDiv.innerHTML = '‚è≥ Logging in...';
            addLog(`üîê Attempting login as @${username}...`);
            
            const result = await apiCall('/api/login', 'POST', { username, password, rememberMe });
            
            loading.classList.remove('active');
            if (result.error) {
                statusDiv.className = 'status-message error mt-2';
                statusDiv.innerHTML = `‚ùå ${result.error}`;
                addLog('‚ùå Login failed: ' + result.error);
            } else {
                statusDiv.className = 'status-message success mt-2';
                statusDiv.innerHTML = `‚úÖ Logged in as @${result.username || username}`;
                addLog(`‚úÖ Successfully logged in as @${result.username || username}`);
                addLog(rememberMe ? 'üîí Session will last 30 days' : '‚è∞ Session will last 24 hours');
                document.getElementById('loginPassword').value = '';
                // Save username to localStorage for convenience
                if (rememberMe) {
                    localStorage.setItem('savedUsername', username);
                }
                checkStatus();
                // Now that the JWT cookie is set, reload scheduler data.
                schedulerLoaded = false;
                loadScheduledTasks();
            }
        }

        async function logout() {
            const loading = document.getElementById('loadingLogin');
            const statusDiv = document.getElementById('loginStatus');
            loading.classList.add('active');
            addLog('üö™ Logging out...');
            
            await apiCall('/api/logout', 'POST');
            
            loading.classList.remove('active');
            statusDiv.className = 'status-message info mt-2';
            statusDiv.innerHTML = 'üö™ Logged out';
            addLog('‚úÖ Logged out successfully');
            checkStatus();
            schedulerLoaded = false;
            const tasksList = document.getElementById('scheduledTasksList');
            if (tasksList) tasksList.innerHTML = '<p style="text-align: center; color: #6b7280;">Login to manage scheduled tasks.</p>';
        }

        async function clearCookies() {
            const loading = document.getElementById('loadingLogin');
            loading.classList.add('active');
            addLog('üßπ Clearing cookies...');
            
            await apiCall('/api/clear-cookies', 'DELETE');
            
            loading.classList.remove('active');
            addLog('‚úÖ Cookies cleared');
        }

        // Proxy configuration functions
        function toggleProxyFields() {
            const enabled = document.getElementById('proxyEnabled').checked;
            const fields = document.getElementById('proxyFields');
            fields.classList.toggle('hidden', !enabled);
        }

        async function saveProxySettings() {
            const enabled = document.getElementById('proxyEnabled').checked;
            const host = document.getElementById('proxyHost').value.trim();
            const port = document.getElementById('proxyPort').value.trim();
            const username = document.getElementById('proxyUsername').value.trim();
            const password = document.getElementById('proxyPassword').value.trim();
            
            if (enabled && (!host || !port)) {
                alert('Please enter proxy host and port');
                return;
            }
            
            const loading = document.getElementById('loadingProxy');
            const statusDiv = document.getElementById('proxyStatus');
            loading.classList.remove('hidden');
            statusDiv.classList.add('hidden');
            addLog('üåê Saving proxy settings...');
            
            const result = await apiCall('/api/proxy/configure', 'POST', {
                enabled,
                host,
                port,
                username,
                password
            });
            
            loading.classList.add('hidden');
            statusDiv.classList.remove('hidden');
            
            if (result.error) {
                statusDiv.className = 'status-message error mt-2';
                statusDiv.innerHTML = `‚ùå ${result.error}`;
                addLog('‚ùå Failed to save proxy settings: ' + result.error);
            } else {
                statusDiv.className = 'status-message success mt-2';
                statusDiv.innerHTML = `‚úÖ ${result.message}`;
                addLog('‚úÖ Proxy settings saved. Restart bot to apply changes.');
                if (enabled) {
                    addLog(`üåê Proxy: ${host}:${port}`);
                }
            }
        }

        async function loadProxySettings() {
            const result = await apiCall('/api/proxy/status');
            if (result && !result.error) {
                document.getElementById('proxyEnabled').checked = result.enabled || false;
                document.getElementById('proxyHost').value = result.host || '';
                document.getElementById('proxyPort').value = result.port || '';
                document.getElementById('proxyUsername').value = result.username || '';
                toggleProxyFields();
            }
        }

        async function checkStatus() {
            const result = await apiCall('/api/status');
            
            const badge = document.getElementById('statusBadge');
            const loginForm = document.getElementById('loginForm');
            const loggedInControls = document.getElementById('loggedInControls');
            const loginStatus = document.getElementById('loginStatus');
            
            if (result.authenticated) {
                // Update badge
                badge.className = 'status-badge online';
                badge.innerHTML = '<div class="pulse"></div><span>Online</span>';
                
                // Hide login form, show logout controls
                loginForm.classList.add('hidden');
                loggedInControls.classList.remove('hidden');
                
                // Update status message
                loginStatus.className = 'status-message success mt-2';
                loginStatus.innerHTML = `‚úÖ Logged in${result.username ? ' as @' + result.username : ''}`;

                // Scheduler is protected by JWT auth; once authenticated, load tasks.
                if (!schedulerLoaded) {
                    schedulerLoaded = true;
                    loadScheduledTasks();
                }
            } else {
                // Update badge
                badge.className = 'status-badge offline';
                badge.innerHTML = '<div class="pulse"></div><span>Offline</span>';
                
                // Show login form, hide logout controls
                loginForm.classList.remove('hidden');
                loggedInControls.classList.add('hidden');
                
                // Update status message
                loginStatus.className = 'status-message error mt-2';
                loginStatus.innerHTML = '‚ùå Not logged in';
                schedulerLoaded = false;
                const tasksList = document.getElementById('scheduledTasksList');
                if (tasksList) tasksList.innerHTML = '<p style="text-align: center; color: #6b7280;">Login to manage scheduled tasks.</p>';
            }
        }

        async function startCommenting() {
            const loading = document.getElementById('loading1');
            loading.classList.add('active');
            
            const mode = document.getElementById('interactionMode').value;
            const maxPosts = parseInt(document.getElementById('maxPostsInput').value, 10) || 10;
            const targetInput = document.getElementById('interactionTarget').value.trim();
            const hashtagInput = document.getElementById('interactionHashtags').value;
            const locationPath = document.getElementById('locationPath').value.trim();
            const competitorUsername = document.getElementById('competitorUsername').value.trim();
            const minLikes = parseInt(document.getElementById('minLikesInput').value, 10);
            const minComments = parseInt(document.getElementById('minCommentsInput').value, 10);
            const englishOnly = document.getElementById('englishOnlyCheckbox').checked;

            const hashtags = hashtagInput.split(',').map(t => t.replace(/^#/, '').trim()).filter(Boolean);

            let targetUsername = targetInput;
            if (mode === 'feed') targetUsername = 'feed';
            else if (mode === 'explore') targetUsername = 'explore';
            else if (mode === 'hashtag') {
                if (!hashtags.length) {
                    alert('Please enter at least one hashtag');
                    loading.classList.remove('active');
                    return;
                }
                targetUsername = `#${hashtags[0]}`;
            } else if (mode === 'location') {
                if (!locationPath) {
                    alert('Please enter a location path');
                    loading.classList.remove('active');
                    return;
                }
                targetUsername = `location:${locationPath}`;
            } else if (mode === 'competitor_followers') {
                if (!competitorUsername) {
                    alert('Please enter a competitor username');
                    loading.classList.remove('active');
                    return;
                }
                targetUsername = undefined;
            }

            const payload = {
                targetUsername,
                maxPosts,
                mode,
                options: {
                    mode,
                    hashtags: hashtags.length ? hashtags : undefined,
                    locationPath: locationPath || undefined,
                    competitorUsername: competitorUsername || undefined,
                    engagement: {
                        minLikes: isNaN(minLikes) ? undefined : minLikes,
                        minComments: isNaN(minComments) ? undefined : minComments,
                    },
                    englishOnly: englishOnly || undefined,
                },
            };

            addLog(`üöÄ Starting ${mode} campaign (${maxPosts} posts)...`);
            const result = await apiCall('/api/interact', 'POST', payload);
            
            loading.classList.remove('active');
            if (result.error) {
                addLog('‚ùå Error: ' + result.error);
            } else {
                addLog(`‚úÖ ${result.message}`);
            }
        }

        async function watchStories() {
            const loading = document.getElementById('loadingStories');
            loading.classList.add('active');
            
            const count = parseInt(document.getElementById('storyCount').value, 10) || 10;
            const target = document.getElementById('storyTarget').value.trim();
            const likeProb = parseFloat(document.getElementById('storyLikeProbability').value) / 100 || 0.3;
            const reactProb = parseFloat(document.getElementById('storyReactionProbability').value) / 100 || 0.2;
            const emoji = document.getElementById('storyReactionEmoji').value.trim() || 'üî•';
            const minWatch = parseFloat(document.getElementById('storyMinWatch').value) * 1000 || 5000;
            const maxWatch = parseFloat(document.getElementById('storyMaxWatch').value) * 1000 || 9000;
            const aiEnabled = document.getElementById('storyAiReplyEnabled').checked;
            const maxReplies = parseInt(document.getElementById('storyAiMaxReplies').value, 10);
            const aiTone = document.getElementById('storyAiTone').value;
            const aiConfidence = parseFloat(document.getElementById('storyAiConfidence').value);
            
            let aiReplyOptions = null;
            if (aiEnabled) {
                aiReplyOptions = {
                    enabled: true,
                    maxReplies: isNaN(maxReplies) ? undefined : maxReplies,
                    tone: aiTone || 'friendly',
                    minConfidence: isNaN(aiConfidence) ? undefined : aiConfidence / 100,
                };
            }

            const payload = {
                storyCount: count,
                targetUsername: target || undefined,
                likeProbability: likeProb,
                reactionProbability: reactProb,
                reactionEmoji: emoji,
                minWatchTimeMs: minWatch,
                maxWatchTimeMs: maxWatch,
            };
            if (aiReplyOptions) {
                payload.aiReply = aiReplyOptions;
            }

            addLog(`üëÅÔ∏è Watching ${count} stories...`);
            const result = await apiCall('/api/stories/watch', 'POST', payload);
            
            loading.classList.remove('active');
            if (result.error) {
                addLog('‚ùå Error: ' + result.error);
            } else {
                addLog('‚úÖ ' + result.message);
            }
        }

        async function sendDM() {
            const username = document.getElementById('dmUsername').value.trim();
            const message = document.getElementById('dmMessage').value.trim();
            
            if (!username || !message) {
                alert('Please fill in both username and message');
                return;
            }

            const loading = document.getElementById('loading2');
            loading.classList.add('active');
            addLog(`üì© Sending DM to @${username}...`);
            
            const result = await apiCall('/api/dm', 'POST', { username, message });
            
            loading.classList.remove('active');
            if (result.error) {
                addLog('‚ùå Error: ' + result.error);
            } else {
                addLog(`‚úÖ DM sent to @${username}`);
                document.getElementById('dmUsername').value = '';
                document.getElementById('dmMessage').value = '';
            }
        }

        async function monitorDMs() {
            const loading = document.getElementById('loading2');
            loading.classList.add('active');
            addLog('üì¨ Monitoring DMs and auto-replying...');
            
            const result = await apiCall('/api/monitor-dms', 'POST');
            
            loading.classList.remove('active');
            if (result.error) {
                addLog('‚ùå Error: ' + result.error);
            } else {
                addLog('‚úÖ ' + result.message);
            }
        }
        
        async function clearDMCache() {
            if (!confirm('Clear the replied conversations cache? This will allow the bot to reply to previously-handled DMs again.')) {
                return;
            }
            
            addLog('üóëÔ∏è Clearing replied conversations cache...');
            const result = await apiCall('/api/dms/clear-cache', 'POST');
            
            if (result.error) {
                addLog('‚ùå Error: ' + result.error);
            } else {
                addLog('‚úÖ ' + result.message);
            }
        }

        async function loadDmAiSettings() {
            const result = await apiCall('/api/dm/ai-settings');
            if (result.error) {
                addLog('‚ùå Error loading DM AI settings: ' + result.error);
                return;
            }
            const s = result.settings || {};
            document.getElementById('dmAiEnabled').checked = s.enabled !== false;
            document.getElementById('dmAiBrandName').value = s.brandName || '';
            document.getElementById('dmAiAbout').value = s.about || '';
            document.getElementById('dmAiOffer').value = s.offer || '';
            document.getElementById('dmAiTone').value = s.tone || 'friendly';
            document.getElementById('dmAiCtaStyle').value = s.ctaStyle || 'question';
            document.getElementById('dmAiEmojiLevel').value = s.emojiLevel || 'low';
            document.getElementById('dmAiMaxSentences').value = s.maxSentences ?? 2;
            document.getElementById('dmAiMaxChars').value = s.maxChars ?? 260;
            document.getElementById('dmAiSignature').value = s.signature || '';
            const avoid = Array.isArray(s.avoidTopics) ? s.avoidTopics.join('\n') : '';
            document.getElementById('dmAiAvoidTopics').value = avoid;
            addLog('‚úÖ DM AI settings loaded');
        }

        async function saveDmAiSettings() {
            const payload = {
                enabled: document.getElementById('dmAiEnabled').checked,
                brandName: document.getElementById('dmAiBrandName').value,
                about: document.getElementById('dmAiAbout').value,
                offer: document.getElementById('dmAiOffer').value,
                tone: document.getElementById('dmAiTone').value,
                ctaStyle: document.getElementById('dmAiCtaStyle').value,
                emojiLevel: document.getElementById('dmAiEmojiLevel').value,
                maxSentences: parseInt(document.getElementById('dmAiMaxSentences').value, 10),
                maxChars: parseInt(document.getElementById('dmAiMaxChars').value, 10),
                signature: document.getElementById('dmAiSignature').value,
                avoidTopics: document.getElementById('dmAiAvoidTopics').value,
            };
            const result = await apiCall('/api/dm/ai-settings', 'PUT', payload);
            if (result.error) {
                addLog('‚ùå Error saving DM AI settings: ' + result.error);
                return;
            }
            addLog('‚úÖ DM AI settings saved');
        }

        async function scrapeFollowers() {
            const targetAccount = document.getElementById('targetAccount').value.trim();
            const maxFollowers = parseInt(document.getElementById('maxFollowers').value);
            
            if (!targetAccount) {
                alert('Please enter a target account');
                return;
            }

            const loading = document.getElementById('loading4');
            loading.classList.add('active');
            addLog(`üë• Scraping followers from @${targetAccount}...`);
            
            const result = await apiCall('/api/scrape-followers', 'POST', { targetAccount, maxFollowers });
            
            loading.classList.remove('active');
            if (result.error) {
                addLog('‚ùå Error: ' + result.error);
            } else {
                addLog(`‚úÖ Scraped ${result.followers?.length || 0} followers`);
            }
        }

        async function checkScheduler() {
            const loading = document.getElementById('loading4');
            loading.classList.add('active');
            addLog('‚è∞ Checking scheduler...');
            
            const result = await apiCall('/api/scheduler/status');
            
            loading.classList.remove('active');
            if (result.error) {
                addLog('‚ùå Error: ' + result.error);
            } else {
                addLog(`‚è∞ Scheduler: ${result.isRunning ? 'Running ‚úÖ' : 'Stopped ‚ùå'}`);
            }
        }

        async function getMyProfile() {
            const loading = document.getElementById('loading4');
            loading.classList.add('active');
            addLog('üë§ Fetching profile...');
            
            const result = await apiCall('/api/me');
            
            loading.classList.remove('active');
            if (result.error) {
                addLog('‚ùå Error: ' + result.error);
            } else {
                addLog(`üë§ Username: ${result.username || 'Unknown'}`);
            }
        }

        let logRefreshInterval = null;
        
        async function loadScreenshots() {
            const gallery = document.getElementById('screenshotGallery');
            gallery.innerHTML = '<p style="text-align: center; color: #667eea;">Loading screenshots...</p>';
            
            const result = await apiCall('/api/screenshots/list');
            
            if (result.error || !result.screenshots) {
                gallery.innerHTML = '<p style="text-align: center; color: #ef4444;">Error loading screenshots</p>';
                return;
            }
            
            if (result.screenshots.length === 0) {
                gallery.innerHTML = '<p style="text-align: center; color: #6b7280;">No screenshots found</p>';
                return;
            }
            
            gallery.innerHTML = '';
            result.screenshots.forEach(screenshot => {
                const item = document.createElement('div');
                item.style.cssText = 'margin-bottom: 15px; padding: 10px; background: #f9fafb; border-radius: 8px; cursor: pointer;';
                item.onclick = () => viewScreenshot(screenshot.type, screenshot.path);
                
                const typeEmoji = screenshot.type === 'post' ? 'üìÑ' : 
                                 screenshot.type === 'profile' ? 'üë§' :
                                 screenshot.type === 'dm' ? 'üí¨' : 'üì∞';
                
                const date = new Date(screenshot.timestamp).toLocaleString();
                
                item.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 24px;">${typeEmoji}</span>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #1f2937;">${screenshot.type.toUpperCase()}</div>
                            <div style="font-size: 12px; color: #6b7280;">${date}</div>
                            <div style="font-size: 11px; color: #9ca3af;">${screenshot.name}</div>
                        </div>
                        <span style="color: #667eea;">üëÅÔ∏è</span>
                    </div>
                `;
                
                gallery.appendChild(item);
            });
            
            addLog(`‚úÖ Loaded ${result.screenshots.length} screenshots`);
        }
        
        function viewScreenshot(type, filename) {
            const url = `${API_URL}/api/screenshots/view/${type}/${filename}`;
            window.open(url, '_blank', 'width=800,height=600');
        }
        
        async function viewLogs() {
            const result = await apiCall('/api/logs/recent?lines=1000'); // Increased from 500 to 1000
            
            if (result.error) {
                console.error('Error fetching logs:', result.error);
                return;
            }
            
            const logs = document.getElementById('logs');
            const rawLogs = result.logs || [];
            let lines = rawLogs.map((item) => {
                if (typeof item === 'string') return item;
                if (item && typeof item === 'object') {
                    const ts = item.timestamp ? String(item.timestamp) : '';
                    const level = item.level ? String(item.level) : 'info';
                    const msg = item.message ? String(item.message) : JSON.stringify(item);
                    return `${ts} ${level}: ${msg}`;
                }
                return String(item);
            });
            
            // Filter based on detail level
            const detailLevel = document.getElementById('logDetailLevel')?.value || 'all';
            if (detailLevel === 'important') {
                // Only show important logs (errors, successes, major actions)
                lines = lines.filter(line => {
                    return line.includes('‚úÖ') || line.includes('‚ùå') || line.includes('‚ö†Ô∏è') ||
                           line.includes('error:') || line.includes('Successfully') ||
                           line.includes('Starting') || line.includes('Complete') ||
                           line.includes('Liked story') || line.includes('AI replied') ||
                           line.includes('Reply sent') || line.includes('Campaign') ||
                           line.includes('logged in') || line.includes('Failed') ||
                           line.includes('DM Monitor') || line.includes('üí¨ DM');
                });
            }
            
            // Clear existing logs and add new ones
            logs.innerHTML = '';
            if (lines.length === 0) {
                const entry = document.createElement('div');
                entry.className = 'log-entry';
                entry.textContent = 'No log entries available.';
                logs.appendChild(entry);
            } else {
                // Show newest first (reverse the array)
                lines.reverse().forEach(line => {
                    const entry = document.createElement('div');
                    entry.className = 'log-entry';
                    
                    // Enhanced color coding to match terminal output
                    if (line.includes('‚úÖ') || line.includes('Successfully') || line.includes('liked') || line.includes('Comment posted') || 
                        line.includes('Liked story') || line.includes('‚ù§Ô∏è') || line.includes('Reply sent') || 
                        line.includes('Story reply sent') || line.includes('AI replied')) {
                        entry.classList.add('log-success');
                    } else if (line.includes('‚ùå') || line.includes('error:') || line.includes('Error') || 
                               line.includes('failed') || line.includes('Failed') || line.includes('timeout')) {
                        entry.classList.add('log-error');
                    } else if (line.includes('‚ö†Ô∏è') || line.includes('warn:') || line.includes('Warning') || 
                               line.includes('Skipping') || line.includes('No dismissal') || line.includes('Unable to')) {
                        entry.classList.add('log-warning');
                    } else if (line.includes('info:') || line.includes('üì°') || line.includes('üìç') || 
                               line.includes('üîç') || line.includes('üì∏') || line.includes('üì©') || 
                               line.includes('üéûÔ∏è') || line.includes('Starting story') || line.includes('Watching') ||
                               line.includes('Checking for') || line.includes('Notification') || 
                               line.includes('screenshot saved') || line.includes('Saved screenshot') ||
                               line.includes('Loaded cookies') || line.includes('logged in') ||
                               line.includes('Navigating') || line.includes('Opening') ||
                               line.includes('üí¨') || line.includes('Attempting to') || line.includes('Found story')) {
                        entry.classList.add('log-info');
                    } else if (line.includes('ü§ñ') || line.includes('AI Story Analysis') || 
                               line.includes('AI Generated') || line.includes('confidence')) {
                        entry.classList.add('log-info');
                        entry.style.backgroundColor = '#f0f9ff'; // Light blue for AI logs
                        entry.style.borderLeft = '3px solid #3b82f6';
                    }
                    
                    entry.textContent = line;
                    logs.appendChild(entry);
                });
            }
            
            // Update log count
            const logCount = document.getElementById('logCount');
            logCount.textContent = `(${lines.length} lines)`;
            
            // Auto-scroll to bottom (newest logs)
            logs.scrollTop = logs.scrollHeight;
        }
        
        function toggleLiveLog() {
            const btn = document.getElementById('liveLogBtn');
            if (logRefreshInterval) {
                // Stop live refresh
                clearInterval(logRefreshInterval);
                logRefreshInterval = null;
                btn.textContent = '‚ñ∂Ô∏è Start Live Log';
                btn.classList.remove('btn-danger');
                btn.classList.add('btn-success');
                addLog('‚è∏Ô∏è Live log stopped');
            } else {
                // Start live refresh
                viewLogs(); // Fetch immediately
                logRefreshInterval = setInterval(viewLogs, 2000); // Refresh every 2 seconds (faster)
                btn.textContent = '‚è∏Ô∏è Stop Live Log';
                btn.classList.remove('btn-success');
                btn.classList.add('btn-danger');
                addLog('‚ñ∂Ô∏è Live log started (updates every 2s)');
            }
        }

        // Auto-refresh status every 30 seconds
        setInterval(checkStatus, 30000);

        // Initialize on load
        window.onload = () => {
            checkStatus();
            updateInteractionFields();
            
            // Auto-fill username if previously saved
            const savedUsername = localStorage.getItem('savedUsername');
            if (savedUsername) {
                const usernameInput = document.getElementById('loginUsername');
                if (usernameInput) {
                    usernameInput.value = savedUsername;
                }
            }
            loadProxySettings();
            // (Note) avoid redeclaring savedUsername here ‚Äî duplicate declarations break the entire dashboard script.
            
            // Add toggle listeners
            document.getElementById('proxyEnabled').addEventListener('change', toggleProxyFields);
            document.getElementById('storyAiReplyEnabled').addEventListener('change', toggleStoryAiOptions);
            toggleStoryAiOptions();

            const aiInput = document.getElementById('aiCommandInput');
            if (aiInput) {
                aiInput.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter' && !event.shiftKey) {
                        event.preventDefault();
                        sendAiCommand();
                    }
                });
            }
            
            addLog('ü§ñ Dashboard loaded - Marketing Team App');
            addLog('üí° Ready to generate leads!');
            
            // Load scheduled tasks on page load
            loadScheduledTasks();
            loadDmAiSettings();
            refreshServerTime();
            startLocalClock();
            setInterval(refreshServerTime, 15000);
            refreshRightRail();
            refreshSystemOverview();
            if (!systemOverviewInterval) {
                systemOverviewInterval = setInterval(refreshSystemOverview, 15000);
            }
            initIgKeepAliveControls();

            // Keep the right rail fresh (lightweight)
            setInterval(refreshRightRail, 8000);
        };
        
        // Scheduled Tasks Functions
        async function loadScheduledTasks() {
            const result = await apiCall('/api/scheduled-tasks');
            const tasksList = document.getElementById('scheduledTasksList');
            
            if (result.error) {
                tasksList.innerHTML = `<p style="color: #ef4444;">‚ùå ${result.error}</p>`;
                return;
            }
            
            if (!result.tasks || result.tasks.length === 0) {
                tasksList.innerHTML = '<p style="text-align: center; color: #6b7280;">No scheduled tasks. Click "Create Scheduled Task" to add one.</p>';
                return;
            }

            // Update cache for editing
            try {
                const byId = {};
                result.tasks.forEach((t) => { if (t && t._id) byId[t._id] = t; });
                window.__scheduledTasksById = byId;
            } catch {
                // ignore
            }
            
            tasksList.innerHTML = result.tasks.map(task => {
                const nextRun = task.nextRun ? new Date(task.nextRun).toLocaleString() : 'Not scheduled';
                const lastRun = task.lastRun ? new Date(task.lastRun).toLocaleString() : 'Never';
                const statusClass = task.enabled ? 'success' : 'error';
                const statusText = task.enabled ? '‚úÖ Enabled' : '‚ùå Disabled';
                const scheduleLabel = (task.scheduleType === 'once')
                    ? `Run once @ ${task.runAt ? new Date(task.runAt).toLocaleString() : 'N/A'}`
                    : (task.cronExpression || 'N/A');
                
                return `
                    <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; margin-bottom: 10px; background: ${task.enabled ? '#f0fdf4' : '#fef2f2'};">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <div>
                                <strong>${task.name}</strong>
                                <span style="margin-left: 8px; padding: 2px 8px; border-radius: 4px; background: #${task.enabled ? '10b981' : 'ef4444'}; color: white; font-size: 12px;">${statusText}</span>
                            </div>
                            <div>
                                <button class="btn-secondary" style="padding: 4px 8px; font-size: 12px;" onclick="showEditTaskModal('${task._id}')">‚úèÔ∏è Edit</button>
                                <button class="btn-secondary" style="padding: 4px 8px; font-size: 12px;" onclick="toggleTask('${task._id}')">${task.enabled ? '‚è∏Ô∏è Disable' : '‚ñ∂Ô∏è Enable'}</button>
                                <button class="btn-danger" style="padding: 4px 8px; font-size: 12px;" onclick="deleteTask('${task._id}')">üóëÔ∏è</button>
                            </div>
                        </div>
                        <div style="font-size: 12px; color: #6b7280;">
                            <div>üìã Type: <strong>${task.taskType}</strong></div>
                            <div>‚è∞ Schedule: <strong>${scheduleLabel}</strong></div>
                            <div>üåç Timezone: <strong>${task.timezone || 'America/New_York'}</strong></div>
                            <div>üîÑ Next Run: <strong>${nextRun}</strong></div>
                            <div>üìä Last Run: <strong>${lastRun}</strong> (${task.runCount || 0} times)</div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function showCreateTaskModal(options = {}) {
            const modal = document.createElement('div');
            modal.id = 'taskModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;';
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 24px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
                    <h2 style="margin-top: 0;">Create Scheduled Task</h2>
                    <form id="taskForm" onsubmit="createTask(event)">
                        <div class="form-group">
                            <label>Task Name *</label>
                            <input type="text" id="taskName" placeholder="e.g. Morning Campaign" required>
                        </div>
                        <div class="form-group">
                            <label>Task Type *</label>
                            <select id="taskType" onchange="updateTaskConfig()" required>
                                <option value="">Select task type...</option>
                                <option value="campaign">Campaign (Like/Comment on Posts)</option>
                                <option value="stories">Watch Stories</option>
                                <option value="dm_monitor">Monitor DMs</option>
                                <option value="profile_scrape">Scrape Followers</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Schedule *</label>
                            <select id="scheduleMode" onchange="toggleScheduleMode()" required>
                                <option value="once" selected>Run once (pick date & time)</option>
                                <option value="every_minutes">Repeat every X minutes</option>
                                <option value="hourly">Repeat hourly</option>
                                <option value="every_hours">Repeat every X hours</option>
                                <option value="daily">Repeat daily at a time</option>
                                <option value="cron">Cron (advanced)</option>
                            </select>
                        </div>
                        <div class="form-group" id="runAtGroup">
                            <label>Run At (your local time) *</label>
                            <input type="datetime-local" id="runAt" required>
                            <small style="display:block;color:#6b7280;margin-top:4px;">
                                Tip: compare with the <strong>Server Time</strong> bar on the scheduler card to avoid timezone confusion.
                            </small>
                        </div>
                        <div class="form-group hidden" id="everyMinutesGroup">
                            <label>Every (minutes) *</label>
                            <select id="everyMinutes">
                                <option value="5">Every 5 minutes</option>
                                <option value="10">Every 10 minutes</option>
                                <option value="15" selected>Every 15 minutes</option>
                                <option value="30">Every 30 minutes</option>
                            </select>
                        </div>
                        <div class="form-group hidden" id="hourlyGroup">
                            <label>Minute of hour *</label>
                            <select id="hourlyMinute">
                                <option value="0" selected>at :00</option>
                                <option value="5">at :05</option>
                                <option value="10">at :10</option>
                                <option value="15">at :15</option>
                                <option value="30">at :30</option>
                                <option value="45">at :45</option>
                            </select>
                        </div>
                        <div class="form-group hidden" id="everyHoursGroup">
                            <label>Every (hours) *</label>
                            <select id="everyHours">
                                <option value="2" selected>Every 2 hours</option>
                                <option value="3">Every 3 hours</option>
                                <option value="4">Every 4 hours</option>
                                <option value="6">Every 6 hours</option>
                                <option value="12">Every 12 hours</option>
                            </select>
                            <small style="display:block;color:#6b7280;margin-top:4px;">
                                Uses your selected timezone below.
                            </small>
                        </div>
                        <div class="form-group hidden" id="dailyGroup">
                            <label>Daily at (time) *</label>
                            <input type="time" id="dailyTime" value="09:00">
                            <small style="display:block;color:#6b7280;margin-top:4px;">
                                Uses your selected timezone below.
                            </small>
                        </div>
                        <div class="form-group hidden" id="cronGroup">
                            <label>Cron Expression *</label>
                            <input type="text" id="cronExpression" placeholder="0 9 * * * (9 AM daily)">
                            <small style="display:block;color:#6b7280;margin-top:4px;">
                                Format: minute hour day month weekday<br>
                                Examples: "0 9 * * *" (9 AM daily), "0 */6 * * *" (every 6 hours), "0 9 * * 1" (9 AM Mondays)
                            </small>
                        </div>
                        <div style="margin-top: -8px; margin-bottom: 14px;">
                            <small id="schedulePreview" style="display:block;color:#6b7280;">
                                Preview: ‚Äî
                            </small>
                        </div>
                        <div class="form-group">
                            <label>Timezone</label>
                            <select id="taskTimezone" onchange="updateSchedulePreview()">
                                <option value="America/New_York">Eastern Time (ET)</option>
                                <option value="America/Chicago">Central Time (CT)</option>
                                <option value="America/Denver">Mountain Time (MT)</option>
                                <option value="America/Los_Angeles">Pacific Time (PT)</option>
                                <option value="UTC">UTC</option>
                            </select>
                        </div>
                        <div id="taskConfigSection"></div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="taskEnabled" checked>
                            <label style="margin: 0;">Enable task immediately</label>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button type="submit" class="btn-primary">‚úÖ Create Task</button>
                            <button type="button" class="btn-secondary" onclick="closeTaskModal()">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            updateTaskConfig();
            toggleScheduleMode();

            // Optional presets to make "autonomous" setup 1-click
            const preset = options?.preset;
            if (preset) {
                const setVal = (id, v) => {
                    const el = document.getElementById(id);
                    if (el) el.value = v;
                };
                if (preset === 'hourly_stories') {
                    setVal('taskName', 'Autopilot: Hourly Stories');
                    setVal('taskType', 'stories');
                    updateTaskConfig();
                    setVal('scheduleMode', 'hourly');
                    toggleScheduleMode();
                    setVal('hourlyMinute', '0');
                    setVal('configStoryCount', '10');
                    updateSchedulePreview();
                } else if (preset === 'hourly_campaign') {
                    setVal('taskName', 'Autopilot: Hourly Campaign');
                    setVal('taskType', 'campaign');
                    updateTaskConfig();
                    setVal('scheduleMode', 'hourly');
                    toggleScheduleMode();
                    setVal('hourlyMinute', '5');
                    setVal('configMaxPosts', '6');
                    updateSchedulePreview();
                } else if (preset === 'dm_15m') {
                    setVal('taskName', 'Autopilot: DM Monitor (15m)');
                    setVal('taskType', 'dm_monitor');
                    updateTaskConfig();
                    setVal('scheduleMode', 'every_minutes');
                    toggleScheduleMode();
                    setVal('everyMinutes', '15');
                    updateSchedulePreview();
                }
            }
        }

        function toggleScheduleMode() {
            const mode = document.getElementById('scheduleMode')?.value || 'once';
            const runAtGroup = document.getElementById('runAtGroup');
            const everyMinutesGroup = document.getElementById('everyMinutesGroup');
            const hourlyGroup = document.getElementById('hourlyGroup');
            const everyHoursGroup = document.getElementById('everyHoursGroup');
            const dailyGroup = document.getElementById('dailyGroup');
            const cronGroup = document.getElementById('cronGroup');

            const runAt = document.getElementById('runAt');
            const cron = document.getElementById('cronExpression');

            // Hide all
            runAtGroup?.classList.add('hidden');
            everyMinutesGroup?.classList.add('hidden');
            hourlyGroup?.classList.add('hidden');
            everyHoursGroup?.classList.add('hidden');
            dailyGroup?.classList.add('hidden');
            cronGroup?.classList.add('hidden');

            if (runAt) runAt.required = false;
            if (cron) cron.required = false;

            if (mode === 'once') {
                runAtGroup?.classList.remove('hidden');
                if (runAt) runAt.required = true;
            } else if (mode === 'every_minutes') {
                everyMinutesGroup?.classList.remove('hidden');
            } else if (mode === 'hourly') {
                hourlyGroup?.classList.remove('hidden');
            } else if (mode === 'every_hours') {
                everyHoursGroup?.classList.remove('hidden');
            } else if (mode === 'daily') {
                dailyGroup?.classList.remove('hidden');
            } else if (mode === 'cron') {
                cronGroup?.classList.remove('hidden');
                if (cron) cron.required = true;
            }

            updateSchedulePreview();
        }

        function updateSchedulePreview() {
            const el = document.getElementById('schedulePreview');
            if (!el) return;
            const mode = document.getElementById('scheduleMode')?.value || 'once';
            const tz = document.getElementById('taskTimezone')?.value || 'America/New_York';

            if (mode === 'once') {
                el.textContent = `Preview: runs once at selected date/time (your local time)`;
                return;
            }
            if (mode === 'every_minutes') {
                const n = parseInt(document.getElementById('everyMinutes')?.value || '15', 10);
                el.textContent = `Preview: repeats every ${n} minutes (cron: */${n} * * * *)`;
                return;
            }
            if (mode === 'hourly') {
                const m = parseInt(document.getElementById('hourlyMinute')?.value || '0', 10);
                el.textContent = `Preview: repeats hourly at :${String(m).padStart(2, '0')} (cron: ${m} * * * *)`;
                return;
            }
            if (mode === 'every_hours') {
                const h = parseInt(document.getElementById('everyHours')?.value || '2', 10);
                el.textContent = `Preview: repeats every ${h} hours (cron: 0 */${h} * * *) [tz: ${tz}]`;
                return;
            }
            if (mode === 'daily') {
                const t = document.getElementById('dailyTime')?.value || '09:00';
                const [hh, mm] = t.split(':').map(x => parseInt(x, 10));
                el.textContent = `Preview: repeats daily at ${t} (cron: ${mm || 0} ${hh || 0} * * *) [tz: ${tz}]`;
                return;
            }
            if (mode === 'cron') {
                const expr = document.getElementById('cronExpression')?.value || '‚Äî';
                el.textContent = `Preview: cron = ${expr} [tz: ${tz}]`;
                return;
            }
            el.textContent = 'Preview: ‚Äî';
        }
        
        function updateTaskConfig() {
            const taskType = document.getElementById('taskType')?.value;
            const configSection = document.getElementById('taskConfigSection');
            if (!configSection) return;
            
            if (taskType === 'campaign') {
                configSection.innerHTML = `
                    <div class="form-group">
                        <label>Mode</label>
                        <select id="configMode">
                            <option value="feed">Recent Feed</option>
                            <option value="hashtag">Hashtag Search</option>
                            <option value="location">Location Search</option>
                            <option value="explore">Explore Page</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Max Posts</label>
                        <input type="number" id="configMaxPosts" value="10" min="1" max="100">
                    </div>
                    <div class="form-group">
                        <label>Hashtags (comma-separated, for hashtag mode)</label>
                        <input type="text" id="configHashtags" placeholder="miami, food, restaurant">
                    </div>
                    <div class="form-group">
                        <label>Location Path (for location mode)</label>
                        <input type="text" id="configLocation" placeholder="212941492/miami-florida">
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="configEnglishOnly">
                        <label style="margin: 0;">English captions only</label>
                    </div>
                `;
            } else if (taskType === 'stories') {
                configSection.innerHTML = `
                    <div class="form-group">
                        <label>Stories to Watch</label>
                        <input type="number" id="configStoryCount" value="10" min="1" max="50">
                    </div>
                    <div class="form-group">
                        <label>Target Username (optional)</label>
                        <input type="text" id="configStoryTarget" placeholder="Leave empty for feed">
                    </div>
                `;
            } else if (taskType === 'dm_monitor') {
                configSection.innerHTML = `
                    <div class="checkbox-group">
                        <input type="checkbox" id="configAutoReply" checked>
                        <label style="margin: 0;">Auto-reply to DMs</label>
                    </div>
                `;
            } else if (taskType === 'profile_scrape') {
                configSection.innerHTML = `
                    <div class="form-group">
                        <label>Target Account</label>
                        <input type="text" id="configScrapeTarget" placeholder="username">
                    </div>
                    <div class="form-group">
                        <label>Max Followers</label>
                        <input type="number" id="configMaxFollowers" value="50" min="1" max="1000">
                    </div>
                `;
            } else {
                configSection.innerHTML = '';
            }
        }

        function toDatetimeLocalValue(isoString) {
            if (!isoString) return '';
            const d = new Date(isoString);
            if (isNaN(d.getTime())) return '';
            const pad = (n) => String(n).padStart(2, '0');
            // datetime-local expects local time, without timezone
            return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
        }

        function inferScheduleModeFromTask(task) {
            if (!task) return { mode: 'once' };
            if (task.scheduleType === 'once') return { mode: 'once' };
            const expr = (task.cronExpression || '').trim();
            // */N * * * *  -> every_minutes
            let m = expr.match(/^\*\/(\d+)\s+\*\s+\*\s+\*\s+\*$/);
            if (m) return { mode: 'every_minutes', everyMinutes: m[1] };
            // M * * * * -> hourly
            m = expr.match(/^(\d{1,2})\s+\*\s+\*\s+\*\s+\*$/);
            if (m) return { mode: 'hourly', hourlyMinute: m[1] };
            // 0 */H * * * -> every_hours
            m = expr.match(/^0\s+\*\/(\d+)\s+\*\s+\*\s+\*$/);
            if (m) return { mode: 'every_hours', everyHours: m[1] };
            // M H * * * -> daily
            m = expr.match(/^(\d{1,2})\s+(\d{1,2})\s+\*\s+\*\s+\*$/);
            if (m) {
                const mm = String(m[1]).padStart(2, '0');
                const hh = String(m[2]).padStart(2, '0');
                return { mode: 'daily', dailyTime: `${hh}:${mm}` };
            }
            return { mode: 'cron', cronExpression: expr };
        }

        function fillTaskConfigFields(task) {
            const taskType = document.getElementById('taskType')?.value;
            const cfg = task?.config || {};

            const setIfExists = (id, value) => {
                const el = document.getElementById(id);
                if (!el) return;
                if (el.type === 'checkbox') el.checked = !!value;
                else el.value = value ?? '';
            };

            if (taskType === 'campaign') {
                setIfExists('configMode', cfg.mode || 'feed');
                setIfExists('configMaxPosts', cfg.maxPosts ?? 10);
                setIfExists('configHashtags', Array.isArray(cfg.hashtags) ? cfg.hashtags.join(', ') : '');
                setIfExists('configLocation', cfg.locationPath || '');
                setIfExists('configEnglishOnly', !!cfg.englishOnly);
            } else if (taskType === 'stories') {
                setIfExists('configStoryCount', cfg.storyCount ?? 10);
                setIfExists('configStoryTarget', cfg.storyTarget || '');
            } else if (taskType === 'dm_monitor') {
                setIfExists('configAutoReply', cfg.autoReply !== false);
            } else if (taskType === 'profile_scrape') {
                setIfExists('configScrapeTarget', cfg.scrapeTarget || '');
                setIfExists('configMaxFollowers', cfg.maxFollowers ?? 50);
            }
        }

        function showEditTaskModal(taskId) {
            const task = (window.__scheduledTasksById || {})[taskId];
            if (!task) {
                alert('Task not found. Try refreshing the scheduler list.');
                return;
            }

            showCreateTaskModal();

            // Update modal title + submit handler
            const modal = document.getElementById('taskModal');
            if (!modal) return;
            const title = modal.querySelector('h2');
            if (title) title.textContent = 'Edit Scheduled Task';

            const form = document.getElementById('taskForm');
            if (form) form.setAttribute('onsubmit', `updateTask(event, '${taskId}')`);

            const submitBtn = modal.querySelector('button[type="submit"]');
            if (submitBtn) submitBtn.textContent = 'üíæ Save Changes';

            // Fill common fields
            document.getElementById('taskName').value = task.name || '';
            document.getElementById('taskType').value = task.taskType || '';
            updateTaskConfig();
            fillTaskConfigFields(task);

            document.getElementById('taskTimezone').value = task.timezone || 'America/New_York';
            document.getElementById('taskEnabled').checked = task.enabled !== false;

            // Fill schedule fields
            const inferred = inferScheduleModeFromTask(task);
            document.getElementById('scheduleMode').value = inferred.mode || 'cron';
            toggleScheduleMode();

            if (inferred.mode === 'once') {
                document.getElementById('runAt').value = toDatetimeLocalValue(task.runAt);
            } else if (inferred.mode === 'every_minutes') {
                document.getElementById('everyMinutes').value = inferred.everyMinutes || '15';
            } else if (inferred.mode === 'hourly') {
                document.getElementById('hourlyMinute').value = inferred.hourlyMinute || '0';
            } else if (inferred.mode === 'every_hours') {
                document.getElementById('everyHours').value = inferred.everyHours || '2';
            } else if (inferred.mode === 'daily') {
                document.getElementById('dailyTime').value = inferred.dailyTime || '09:00';
            } else {
                document.getElementById('cronExpression').value = task.cronExpression || '';
            }

            updateSchedulePreview();
        }

        function collectTaskFormPayload() {
            const taskType = document.getElementById('taskType').value;
            const config = {};

            if (taskType === 'campaign') {
                config.mode = document.getElementById('configMode').value;
                config.maxPosts = parseInt(document.getElementById('configMaxPosts').value) || 10;
                const hashtags = document.getElementById('configHashtags').value;
                if (hashtags) config.hashtags = hashtags.split(',').map(h => h.trim()).filter(Boolean);
                const location = document.getElementById('configLocation').value;
                if (location) config.locationPath = location;
                config.englishOnly = document.getElementById('configEnglishOnly').checked;
            } else if (taskType === 'stories') {
                config.storyCount = parseInt(document.getElementById('configStoryCount').value) || 10;
                const target = document.getElementById('configStoryTarget').value;
                if (target) config.storyTarget = target;
            } else if (taskType === 'dm_monitor') {
                config.autoReply = document.getElementById('configAutoReply').checked;
            } else if (taskType === 'profile_scrape') {
                config.scrapeTarget = document.getElementById('configScrapeTarget').value;
                config.maxFollowers = parseInt(document.getElementById('configMaxFollowers').value) || 50;
            }

            const mode = document.getElementById('scheduleMode').value;
            const runAtVal = document.getElementById('runAt')?.value;
            const tz = document.getElementById('taskTimezone').value;

            let scheduleType = 'cron';
            let cronExpression = undefined;
            let runAt = undefined;

            if (mode === 'once') {
                scheduleType = 'once';
                runAt = runAtVal ? new Date(runAtVal).toISOString() : undefined;
            } else if (mode === 'every_minutes') {
                const n = parseInt(document.getElementById('everyMinutes').value, 10) || 15;
                cronExpression = `*/${n} * * * *`;
            } else if (mode === 'hourly') {
                const m = parseInt(document.getElementById('hourlyMinute').value, 10) || 0;
                cronExpression = `${m} * * * *`;
            } else if (mode === 'every_hours') {
                const h = parseInt(document.getElementById('everyHours').value, 10) || 2;
                cronExpression = `0 */${h} * * *`;
            } else if (mode === 'daily') {
                const t = document.getElementById('dailyTime').value || '09:00';
                const [hh, mm] = t.split(':').map(x => parseInt(x, 10));
                cronExpression = `${mm || 0} ${hh || 0} * * *`;
            } else if (mode === 'cron') {
                cronExpression = document.getElementById('cronExpression').value;
            }

            return {
                name: document.getElementById('taskName').value,
                taskType,
                scheduleType,
                cronExpression,
                runAt,
                timezone: tz,
                config,
                enabled: document.getElementById('taskEnabled').checked
            };
        }
        
        async function createTask(event) {
            event.preventDefault();
            const payload = collectTaskFormPayload();
            
            const result = await apiCall('/api/scheduled-tasks', 'POST', payload);
            if (result.error) {
                alert('Error: ' + result.error);
            } else {
                addLog(`‚úÖ Scheduled task "${payload.name}" created`);
                closeTaskModal();
                loadScheduledTasks();
            }
        }

        async function updateTask(event, id) {
            event.preventDefault();
            const payload = collectTaskFormPayload();
            const result = await apiCall(`/api/scheduled-tasks/${id}`, 'PUT', payload);
            if (result.error) {
                alert('Error: ' + result.error);
            } else {
                addLog(`‚úÖ Scheduled task "${payload.name}" updated`);
                closeTaskModal();
                loadScheduledTasks();
            }
        }
        
        async function toggleTask(id) {
            const result = await apiCall(`/api/scheduled-tasks/${id}/toggle`, 'PATCH');
            if (result.error) {
                alert('Error: ' + result.error);
            } else {
                addLog(`‚úÖ Task ${result.task.enabled ? 'enabled' : 'disabled'}`);
                loadScheduledTasks();
            }
        }
        
        async function deleteTask(id) {
            if (!confirm('Are you sure you want to delete this scheduled task?')) return;
            const result = await apiCall(`/api/scheduled-tasks/${id}`, 'DELETE');
            if (result.error) {
                alert('Error: ' + result.error);
            } else {
                addLog('‚úÖ Scheduled task deleted');
                loadScheduledTasks();
            }
        }
        
        function closeTaskModal() {
            const modal = document.getElementById('taskModal');
            if (modal) modal.remove();
        }

        async function refreshServerTime() {
            const serverTimeEl = document.getElementById('serverTimeValue');
            const serverTzEl = document.getElementById('serverTzValue');
            if (!serverTimeEl || !serverTzEl) return;
            const result = await apiCall('/api/time');
            if (result?.serverTimeIso) {
                const dt = new Date(result.serverTimeIso);
                serverTimeEl.textContent = isNaN(dt.getTime()) ? String(result.serverTimeIso) : dt.toLocaleString();
                serverTzEl.textContent = result.serverTimezone || 'UTC';
            } else {
                serverTimeEl.textContent = 'Unavailable';
                serverTzEl.textContent = '‚Äî';
            }
        }

        async function refreshSystemOverview() {
            try {
                const [timeRes, statusRes, proxyRes, aiRes, metricsRes] = await Promise.all([
                    apiCall('/api/time'),
                    apiCall('/api/status'),
                    apiCall('/api/proxy/status'),
                    apiCall('/api/ai/status'),
                    apiCall('/api/metrics/daily'),
                ]);

                if (timeRes?.serverTimeIso) {
                    const dt = new Date(timeRes.serverTimeIso);
                    const tz = timeRes.serverTimezone || 'UTC';
                    setPill('pillServerTime', `‚è±Ô∏è Server: ${isNaN(dt.getTime()) ? String(timeRes.serverTimeIso) : dt.toLocaleTimeString()} (${tz})`, 'neutral');
                    setPill('pillUptime', `üß† Uptime: ${timeRes.uptimeSec ?? '?'}s`, 'neutral');
                } else {
                    setPill('pillServerTime', '‚è±Ô∏è Server: unknown', 'warn');
                    setPill('pillUptime', 'üß† Uptime: unknown', 'warn');
                }

                if (statusRes && !statusRes.error) {
                    setPill('pillDb', `üóÑÔ∏è DB: ${statusRes.dbConnected ? 'connected' : 'offline'}`, statusRes.dbConnected ? 'ok' : 'bad');
                    setPill('pillAuth', `üîê Dashboard: ${statusRes.authenticated ? 'logged in' : 'logged out'}`, statusRes.authenticated ? 'ok' : 'warn');
                } else {
                    setPill('pillDb', 'üóÑÔ∏è DB: unknown', 'warn');
                    setPill('pillAuth', 'üîê Dashboard: unknown', 'warn');
                }

                if (proxyRes && !proxyRes.error) {
                    setPill('pillProxy', `üåê Proxy: ${proxyRes.enabled ? 'enabled' : 'off'}`, proxyRes.enabled ? 'ok' : 'neutral');
                } else {
                    setPill('pillProxy', 'üåê Proxy: unknown', 'warn');
                }

                if (aiRes && !aiRes.error) {
                    const configured = !!aiRes.configured;
                    setPill('pillAi', `ü§ñ Gemini: ${configured ? `configured (${aiRes.keysConfigured})` : 'not set'}`, configured ? 'ok' : 'bad');
                } else {
                    setPill('pillAi', 'ü§ñ Gemini: unknown', 'warn');
                }

                // IG session health (requires auth)
                if (statusRes && !statusRes.error && statusRes.authenticated) {
                    const sessRes = await apiCall('/api/session/status');
                    if (sessRes && !sessRes.error) {
                        const ok = !!sessRes.isLoggedIn;
                        const next = sessRes.session?.nextRefresh ? new Date(sessRes.session.nextRefresh) : null;
                        const last = sessRes.session?.lastRefresh ? new Date(sessRes.session.lastRefresh) : null;
                        const nextStr = next && !isNaN(next.getTime()) ? next.toLocaleTimeString() : 'n/a';
                        const lastStr = last && !isNaN(last.getTime()) ? last.toLocaleTimeString() : 'n/a';
                        setPill('pillIgSession', `üì± IG: ${ok ? 'ok' : 'logged out'} (last ${lastStr}, next ${nextStr})`, ok ? 'ok' : 'bad');
                    } else {
                        setPill('pillIgSession', 'üì± IG: unknown', 'warn');
                    }
                } else {
                    setPill('pillIgSession', 'üì± IG: login required', 'neutral');
                }

                if (metricsRes && !metricsRes.error && metricsRes.counts) {
                    const c = metricsRes.counts;
                    const text = `üìä Today: ‚ù§Ô∏è ${c.campaignLikes || 0} ¬∑ üí¨ ${c.campaignComments || 0} ¬∑ üì© ${c.dmsSent || 0} ¬∑ ‚Ü©Ô∏è ${c.dmRepliesSent || 0} ¬∑ üëÄ ${c.storyViews || 0}`;
                    setPill('pillToday', text, 'neutral');
                } else {
                    setPill('pillToday', 'üìä Today: unknown', 'warn');
                }
            } catch {
                // ignore
            }
        }

        function initIgKeepAliveControls() {
            const toggle = document.getElementById('igKeepAliveToggle');
            const intervalSel = document.getElementById('igKeepAliveInterval');
            if (!toggle || !intervalSel) return;

            // Restore saved settings
            const savedEnabled = localStorage.getItem('igKeepAliveEnabled');
            const savedInterval = localStorage.getItem('igKeepAliveMinutes');
            if (savedEnabled !== null) toggle.checked = savedEnabled === 'true';
            if (savedInterval) intervalSel.value = savedInterval;

            const apply = () => {
                localStorage.setItem('igKeepAliveEnabled', String(toggle.checked));
                localStorage.setItem('igKeepAliveMinutes', String(intervalSel.value));
                startIgKeepAliveLoop();
            };

            toggle.addEventListener('change', apply);
            intervalSel.addEventListener('change', apply);
            startIgKeepAliveLoop();
        }

        function startIgKeepAliveLoop() {
            if (igKeepAliveIntervalHandle) {
                clearInterval(igKeepAliveIntervalHandle);
                igKeepAliveIntervalHandle = null;
            }
            const toggle = document.getElementById('igKeepAliveToggle');
            const intervalSel = document.getElementById('igKeepAliveInterval');
            if (!toggle || !intervalSel) return;
            if (!toggle.checked) return;

            const minutes = parseInt(intervalSel.value, 10) || 30;
            igKeepAliveIntervalHandle = setInterval(() => {
                maybeRefreshIgSession('auto');
            }, minutes * 60 * 1000);

            // kick off soon after enabling
            setTimeout(() => maybeRefreshIgSession('auto'), 5000);
        }

        async function maybeRefreshIgSession(source = 'auto') {
            const now = Date.now();
            if (now - lastIgKeepAliveAttemptAt < 30_000) return; // debounce
            lastIgKeepAliveAttemptAt = now;

            // Only when authenticated
            const statusRes = await apiCall('/api/status');
            if (!statusRes || statusRes.error || !statusRes.authenticated) return;

            // Skip if scheduler actively running a task
            const sched = await apiCall('/api/scheduler/status');
            if (sched && !sched.error && sched.isRunning) {
                addLog(`‚è≠Ô∏è IG keep-alive skipped (scheduler busy)`);
                return;
            }

            const res = await apiCall('/api/session/refresh', 'POST', {});
            if (res && !res.error) {
                addLog(`‚úÖ IG session refreshed (${source})`);
            } else {
                addLog(`‚ö†Ô∏è IG session refresh failed (${source}): ${res?.error || 'unknown'}`);
            }
        }

        async function refreshIgSessionNow() {
            return maybeRefreshIgSession('manual');
        }

        function startLocalClock() {
            const localEl = document.getElementById('localTimeValue');
            if (!localEl) return;
            localEl.textContent = new Date().toLocaleTimeString();
            setInterval(() => {
                localEl.textContent = new Date().toLocaleTimeString();
            }, 1000);
        }
    </script>
</body>
</html>
