<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instagram Bot Dashboard - Marketing Team App</title>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --dark: #1f2937;
            --light: #f9fafb;
            --border: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--dark);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* Header */
        .header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .header h1 {
            font-size: 2em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 600;
            background: var(--light);
            border: 2px solid var(--border);
        }
        
        .status-badge.online {
            background: #d1fae5;
            border-color: var(--success);
            color: var(--success);
        }
        
        .status-badge.offline {
            background: #fee2e2;
            border-color: var(--danger);
            color: var(--danger);
        }
        
        .pulse {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Grid Layout */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        }
        
        /* Cards */
        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: var(--shadow);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light);
        }
        
        .card-icon {
            font-size: 28px;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            color: white;
        }
        
        .card h2 {
            font-size: 1.3em;
            color: var(--dark);
            flex: 1;
        }
        
        /* Form Elements */
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--dark);
            font-size: 14px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s;
            font-family: inherit;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        /* Buttons */
        button {
            width: 100%;
            padding: 14px 20px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 10px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-info {
            background: var(--info);
            color: white;
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        /* Checkbox */
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: var(--light);
            border-radius: 10px;
            cursor: pointer;
            margin: 10px 0;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: auto;
            cursor: pointer;
        }
        
        /* Status Messages */
        .status-message {
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-message.success {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-message.error {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .status-message.info {
            background: #dbeafe;
            color: #1e40af;
        }
        
        /* Loading Spinner */
        .loading {
            display: none;
            text-align: center;
            padding: 15px;
            color: var(--primary);
            font-weight: 600;
        }
        
        .loading.active {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid var(--light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Logs */
        .log-container {
            background: var(--dark);
            color: #d1d5db;
            padding: 20px;
            border-radius: 10px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
        }
        
        .log-entry {
            padding: 8px 12px;
            margin-bottom: 4px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.05);
            border-left: 3px solid #6b7280;
        }
        
        .log-entry.log-success {
            color: #10b981;
            border-left-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }
        
        .log-entry.log-error {
            color: #ef4444;
            border-left-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }
        
        .log-entry.log-warning {
            color: #f59e0b;
            border-left-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }
        
        .log-entry.log-info {
            color: #3b82f6;
            border-left-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }
        
        .log-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .log-container::-webkit-scrollbar-track {
            background: #374151;
            border-radius: 10px;
        }
        
        .log-container::-webkit-scrollbar-thumb {
            background: #6b7280;
            border-radius: 10px;
        }
        
        /* Collapsible Sections */
        .collapsible {
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: var(--light);
            border-radius: 10px;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .collapsible:hover {
            background: #e5e7eb;
        }
        
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .collapsible-content.active {
            max-height: 1000px;
        }
        
        .arrow {
            transition: transform 0.3s;
        }
        
        .arrow.active {
            transform: rotate(180deg);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
            }
            
            .grid {
                grid-template-columns: 1fr;
            }
            
            .grid-2 {
                grid-template-columns: 1fr;
            }
        }
        
        /* Utility Classes */
        .mt-2 { margin-top: 10px; }
        .mb-2 { margin-bottom: 10px; }
        .text-center { text-align: center; }
        .flex { display: flex; }
        .gap-2 { gap: 10px; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>
                <span>ü§ñ</span>
                Instagram Lead Gen Copilot
            </h1>
            <div id="statusBadge" class="status-badge offline">
                <div class="pulse"></div>
                <span>Checking...</span>
            </div>
        </div>
        
        <!-- Main Grid -->
        <div class="grid">
            <!-- Account Control -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">üîê</div>
                    <h2>Account</h2>
                </div>
                
                <!-- Login Form (shown when logged out) -->
                <div id="loginForm">
                    <div class="form-group">
                        <label>Instagram Username</label>
                        <input type="text" id="loginUsername" placeholder="your_username">
                    </div>
                    <div class="form-group">
                        <label>Instagram Password</label>
                        <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="rememberMeCheckbox" checked>
                        <label style="margin: 0;">Remember me for 7 days</label>
                    </div>
                    <button class="btn-success" onclick="login()">üîì Login</button>
                </div>
                
                <!-- Logged In Controls (shown when logged in) -->
                <div id="loggedInControls" class="hidden">
                    <button class="btn-danger" onclick="logout()">üö™ Logout</button>
                    <button class="btn-secondary" onclick="clearCookies()">üßπ Clear Cookies</button>
                </div>
                
                <div class="loading" id="loadingLogin">
                    <div class="spinner"></div>
                    <span>Processing...</span>
                </div>
                <div id="loginStatus" class="status-message info mt-2">
                    ‚ÑπÔ∏è Checking status...
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">‚ö°</div>
                    <h2>Lead Generation</h2>
                </div>
                <div class="form-group">
                    <label>Targeting Mode</label>
                    <select id="interactionMode" onchange="updateInteractionFields()">
                        <option value="feed">Recent Feed</option>
                        <option value="explore">Explore Page</option>
                        <option value="hashtag">Hashtag Search</option>
                        <option value="location">Location Search</option>
                        <option value="user">Specific User</option>
                        <option value="competitor_followers">Competitor Followers</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Max Posts to Process</label>
                    <input type="number" id="maxPostsInput" value="10" min="1" max="100">
                </div>
                
                <!-- Dynamic Fields -->
                <div id="targetUsernameGroup" class="form-group hidden">
                    <label>Target Username</label>
                    <input type="text" id="interactionTarget" placeholder="username (no @)">
                </div>
                <div id="hashtagGroup" class="form-group hidden">
                    <label>Hashtags (comma separated)</label>
                    <input type="text" id="interactionHashtags" placeholder="restaurant, miami, food">
                </div>
                <div id="locationGroup" class="form-group hidden">
                    <label>Location Path</label>
                    <input type="text" id="locationPath" placeholder="212941492/miami-florida">
                </div>
                <div id="competitorGroup" class="form-group hidden">
                    <label>Competitor Username</label>
                    <input type="text" id="competitorUsername" placeholder="competitor_username">
                </div>
                
                <!-- Advanced Options -->
                <div class="collapsible" onclick="toggleCollapsible('advancedOptions')">
                    <span>‚öôÔ∏è Advanced Filters</span>
                    <span class="arrow" id="advancedOptionsArrow">‚ñº</span>
                </div>
                <div id="advancedOptions" class="collapsible-content">
                    <div class="form-group">
                        <label>Min Likes (optional)</label>
                        <input type="number" id="minLikesInput" placeholder="e.g., 50">
                    </div>
                    <div class="form-group">
                        <label>Min Comments (optional)</label>
                        <input type="number" id="minCommentsInput" placeholder="e.g., 5">
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="englishOnlyCheckbox" checked>
                        <label style="margin: 0;">English captions only</label>
                    </div>
                </div>
                
                <button class="btn-primary" onclick="startCommenting()">üöÄ Start Campaign</button>
                <button class="btn-info" onclick="checkStatus()">üìä Check Status</button>
                <div class="loading" id="loading1">
                    <div class="spinner"></div>
                    <span>Running campaign...</span>
                </div>
            </div>
            
            <!-- Story Viewer -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">üì∫</div>
                    <h2>Story Engagement</h2>
                </div>
                <div class="form-group">
                    <label>Stories to Watch</label>
                    <input type="number" id="storyCount" value="10" min="1" max="50">
                </div>
                <div class="form-group">
                    <label>Target User (optional)</label>
                    <input type="text" id="storyTarget" placeholder="Leave empty for feed">
                </div>
                <div class="flex gap-2">
                    <div class="form-group" style="flex: 1;">
                        <label>Like % (0-100)</label>
                        <input type="number" id="storyLikeProbability" value="30" min="0" max="100">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>React % (0-100)</label>
                        <input type="number" id="storyReactionProbability" value="20" min="0" max="100">
                    </div>
                </div>
                <div class="form-group">
                    <label>Reaction Emoji</label>
                    <input type="text" id="storyReactionEmoji" value="üî•" maxlength="2">
                </div>
                <div class="flex gap-2">
                    <div class="form-group" style="flex: 1;">
                        <label>Min Watch (sec)</label>
                        <input type="number" id="storyMinWatch" value="5" min="2">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Max Watch (sec)</label>
                        <input type="number" id="storyMaxWatch" value="9" min="3">
                    </div>
                </div>
                <button class="btn-primary" onclick="watchStories()">üëÅÔ∏è Watch Stories</button>
                <div class="loading" id="loadingStories">
                    <div class="spinner"></div>
                    <span>Watching stories...</span>
                </div>
            </div>
        </div>
        
        <!-- Second Row -->
        <div class="grid">
            <!-- DM Management -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">üí¨</div>
                    <h2>Direct Messages</h2>
                </div>
                <button class="btn-primary" onclick="monitorDMs()">üì¨ Monitor & Auto-Reply</button>
                <div class="collapsible mt-2" onclick="toggleCollapsible('sendDMSection')">
                    <span>üì© Send Manual DM</span>
                    <span class="arrow" id="sendDMSectionArrow">‚ñº</span>
                </div>
                <div id="sendDMSection" class="collapsible-content">
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="dmUsername" placeholder="username (no @)">
                    </div>
                    <div class="form-group">
                        <label>Message</label>
                        <textarea id="dmMessage" placeholder="Your message..."></textarea>
                    </div>
                    <button class="btn-success" onclick="sendDM()">Send DM</button>
                </div>
                <div class="loading" id="loading2">
                    <div class="spinner"></div>
                    <span>Processing DMs...</span>
                </div>
            </div>
            
            <!-- Advanced Tools -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">üõ†Ô∏è</div>
                    <h2>Tools</h2>
                </div>
                <button class="btn-info" onclick="viewLogs()">üìã View Recent Logs</button>
                <button id="liveLogBtn" class="btn-success" onclick="toggleLiveLog()">‚ñ∂Ô∏è Start Live Log</button>
                <button class="btn-info" onclick="checkScheduler()">‚è∞ Scheduler Status</button>
                <button class="btn-success" onclick="getMyProfile()">üë§ My Profile Info</button>
                <div class="collapsible mt-2" onclick="toggleCollapsible('scraperSection')">
                    <span>üë• Follower Scraper</span>
                    <span class="arrow" id="scraperSectionArrow">‚ñº</span>
                </div>
                <div id="scraperSection" class="collapsible-content">
                    <div class="form-group">
                        <label>Target Account</label>
                        <input type="text" id="targetAccount" placeholder="username">
                    </div>
                    <div class="form-group">
                        <label>Max Followers</label>
                        <input type="number" id="maxFollowers" value="50" min="1">
                    </div>
                    <button class="btn-info" onclick="scrapeFollowers()">Scrape Followers</button>
                </div>
                <div class="loading" id="loading4">
                    <div class="spinner"></div>
                    <span>Processing...</span>
                </div>
            </div>
        </div>
        
        <!-- Logs and Screenshots Section -->
        <div class="grid grid-2">
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">üìú</div>
                    <h2>Activity Logs</h2>
                </div>
                <div class="log-container" id="logs">
                    <!-- Logs will appear here with newest at top -->
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">üì∏</div>
                    <h2>Screenshot Viewer</h2>
                </div>
                <button class="btn-primary" onclick="loadScreenshots()">üîÑ Refresh Screenshots</button>
                <div id="screenshotGallery" style="margin-top: 15px; max-height: 400px; overflow-y: auto;">
                    <p style="text-align: center; color: #6b7280;">Click refresh to load recent screenshots</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;

        async function apiCall(endpoint, method = 'GET', body = null) {
            try {
                const options = {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include'
                };
                if (body) options.body = JSON.stringify(body);
                
                const response = await fetch(`${API_URL}${endpoint}`, options);
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                return { error: error.message };
            }
        }

        function addLog(message) {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            
            // Determine log type based on message content for color coding
            let logClass = '';
            if (message.includes('‚úÖ') || message.includes('Success')) {
                logClass = 'log-success';
            } else if (message.includes('‚ùå') || message.includes('Error') || message.includes('Failed')) {
                logClass = 'log-error';
            } else if (message.includes('‚ö†Ô∏è') || message.includes('Warning')) {
                logClass = 'log-warning';
            } else if (message.includes('üöÄ') || message.includes('Starting')) {
                logClass = 'log-info';
            }
            
            // Create log entry and prepend (newest at top)
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${logClass}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            // Insert at the beginning instead of appending
            if (logs.firstChild) {
                logs.insertBefore(logEntry, logs.firstChild);
            } else {
                logs.appendChild(logEntry);
            }
            
            // Keep only last 100 log entries to prevent memory issues
            while (logs.children.length > 100) {
                logs.removeChild(logs.lastChild);
            }
        }

        function toggleCollapsible(id) {
            const content = document.getElementById(id);
            const arrow = document.getElementById(id + 'Arrow');
            content.classList.toggle('active');
            arrow.classList.toggle('active');
        }

        function updateInteractionFields() {
            const mode = document.getElementById('interactionMode').value;
            document.getElementById('targetUsernameGroup').classList.toggle('hidden', mode !== 'user');
            document.getElementById('hashtagGroup').classList.toggle('hidden', mode !== 'hashtag');
            document.getElementById('locationGroup').classList.toggle('hidden', mode !== 'location');
            document.getElementById('competitorGroup').classList.toggle('hidden', mode !== 'competitor_followers');
        }

        async function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const rememberMe = document.getElementById('rememberMeCheckbox').checked;
            
            if (!username || !password) {
                alert('Please enter both username and password');
                return;
            }

            const loading = document.getElementById('loadingLogin');
            const statusDiv = document.getElementById('loginStatus');
            loading.classList.add('active');
            statusDiv.className = 'status-message info mt-2';
            statusDiv.innerHTML = '‚è≥ Logging in...';
            addLog(`üîê Attempting login as @${username}...`);
            
            const result = await apiCall('/api/login', 'POST', { username, password, rememberMe });
            
            loading.classList.remove('active');
            if (result.error) {
                statusDiv.className = 'status-message error mt-2';
                statusDiv.innerHTML = `‚ùå ${result.error}`;
                addLog('‚ùå Login failed: ' + result.error);
            } else {
                statusDiv.className = 'status-message success mt-2';
                statusDiv.innerHTML = `‚úÖ Logged in as @${result.username || username}`;
                addLog(`‚úÖ Successfully logged in as @${result.username || username}`);
                addLog(rememberMe ? 'üîí Session will last 7 days' : '‚è∞ Session will last 2 hours');
                document.getElementById('loginPassword').value = '';
                // Save username to localStorage for convenience
                if (rememberMe) {
                    localStorage.setItem('savedUsername', username);
                }
                checkStatus();
            }
        }

        async function logout() {
            const loading = document.getElementById('loadingLogin');
            const statusDiv = document.getElementById('loginStatus');
            loading.classList.add('active');
            addLog('üö™ Logging out...');
            
            await apiCall('/api/logout', 'POST');
            
            loading.classList.remove('active');
            statusDiv.className = 'status-message info mt-2';
            statusDiv.innerHTML = 'üö™ Logged out';
            addLog('‚úÖ Logged out successfully');
            checkStatus();
        }

        async function clearCookies() {
            const loading = document.getElementById('loadingLogin');
            loading.classList.add('active');
            addLog('üßπ Clearing cookies...');
            
            await apiCall('/api/clear-cookies', 'DELETE');
            
            loading.classList.remove('active');
            addLog('‚úÖ Cookies cleared');
        }

        async function checkStatus() {
            const result = await apiCall('/api/status');
            
            const badge = document.getElementById('statusBadge');
            const loginForm = document.getElementById('loginForm');
            const loggedInControls = document.getElementById('loggedInControls');
            const loginStatus = document.getElementById('loginStatus');
            
            if (result.authenticated) {
                // Update badge
                badge.className = 'status-badge online';
                badge.innerHTML = '<div class="pulse"></div><span>Online</span>';
                
                // Hide login form, show logout controls
                loginForm.classList.add('hidden');
                loggedInControls.classList.remove('hidden');
                
                // Update status message
                loginStatus.className = 'status-message success mt-2';
                loginStatus.innerHTML = `‚úÖ Logged in${result.username ? ' as @' + result.username : ''}`;
            } else {
                // Update badge
                badge.className = 'status-badge offline';
                badge.innerHTML = '<div class="pulse"></div><span>Offline</span>';
                
                // Show login form, hide logout controls
                loginForm.classList.remove('hidden');
                loggedInControls.classList.add('hidden');
                
                // Update status message
                loginStatus.className = 'status-message error mt-2';
                loginStatus.innerHTML = '‚ùå Not logged in';
            }
        }

        async function startCommenting() {
            const loading = document.getElementById('loading1');
            loading.classList.add('active');
            
            const mode = document.getElementById('interactionMode').value;
            const maxPosts = parseInt(document.getElementById('maxPostsInput').value, 10) || 10;
            const targetInput = document.getElementById('interactionTarget').value.trim();
            const hashtagInput = document.getElementById('interactionHashtags').value;
            const locationPath = document.getElementById('locationPath').value.trim();
            const competitorUsername = document.getElementById('competitorUsername').value.trim();
            const minLikes = parseInt(document.getElementById('minLikesInput').value, 10);
            const minComments = parseInt(document.getElementById('minCommentsInput').value, 10);
            const englishOnly = document.getElementById('englishOnlyCheckbox').checked;

            const hashtags = hashtagInput.split(',').map(t => t.replace(/^#/, '').trim()).filter(Boolean);

            let targetUsername = targetInput;
            if (mode === 'feed') targetUsername = 'feed';
            else if (mode === 'explore') targetUsername = 'explore';
            else if (mode === 'hashtag') {
                if (!hashtags.length) {
                    alert('Please enter at least one hashtag');
                    loading.classList.remove('active');
                    return;
                }
                targetUsername = `#${hashtags[0]}`;
            } else if (mode === 'location') {
                if (!locationPath) {
                    alert('Please enter a location path');
                    loading.classList.remove('active');
                    return;
                }
                targetUsername = `location:${locationPath}`;
            } else if (mode === 'competitor_followers') {
                if (!competitorUsername) {
                    alert('Please enter a competitor username');
                    loading.classList.remove('active');
                    return;
                }
                targetUsername = undefined;
            }

            const payload = {
                targetUsername,
                maxPosts,
                mode,
                options: {
                    mode,
                    hashtags: hashtags.length ? hashtags : undefined,
                    locationPath: locationPath || undefined,
                    competitorUsername: competitorUsername || undefined,
                    engagement: {
                        minLikes: isNaN(minLikes) ? undefined : minLikes,
                        minComments: isNaN(minComments) ? undefined : minComments,
                    },
                    englishOnly: englishOnly || undefined,
                },
            };

            addLog(`üöÄ Starting ${mode} campaign (${maxPosts} posts)...`);
            const result = await apiCall('/api/interact', 'POST', payload);
            
            loading.classList.remove('active');
            if (result.error) {
                addLog('‚ùå Error: ' + result.error);
            } else {
                addLog(`‚úÖ ${result.message}`);
            }
        }

        async function watchStories() {
            const loading = document.getElementById('loadingStories');
            loading.classList.add('active');
            
            const count = parseInt(document.getElementById('storyCount').value, 10) || 10;
            const target = document.getElementById('storyTarget').value.trim();
            const likeProb = parseFloat(document.getElementById('storyLikeProbability').value) / 100 || 0.3;
            const reactProb = parseFloat(document.getElementById('storyReactionProbability').value) / 100 || 0.2;
            const emoji = document.getElementById('storyReactionEmoji').value.trim() || 'üî•';
            const minWatch = parseFloat(document.getElementById('storyMinWatch').value) * 1000 || 5000;
            const maxWatch = parseFloat(document.getElementById('storyMaxWatch').value) * 1000 || 9000;

            const payload = {
                storyCount: count,
                targetUsername: target || undefined,
                likeProbability: likeProb,
                reactionProbability: reactProb,
                reactionEmoji: emoji,
                minWatchTimeMs: minWatch,
                maxWatchTimeMs: maxWatch,
            };

            addLog(`üëÅÔ∏è Watching ${count} stories...`);
            const result = await apiCall('/api/stories/watch', 'POST', payload);
            
            loading.classList.remove('active');
            if (result.error) {
                addLog('‚ùå Error: ' + result.error);
            } else {
                addLog('‚úÖ ' + result.message);
            }
        }

        async function sendDM() {
            const username = document.getElementById('dmUsername').value.trim();
            const message = document.getElementById('dmMessage').value.trim();
            
            if (!username || !message) {
                alert('Please fill in both username and message');
                return;
            }

            const loading = document.getElementById('loading2');
            loading.classList.add('active');
            addLog(`üì© Sending DM to @${username}...`);
            
            const result = await apiCall('/api/dm', 'POST', { username, message });
            
            loading.classList.remove('active');
            if (result.error) {
                addLog('‚ùå Error: ' + result.error);
            } else {
                addLog(`‚úÖ DM sent to @${username}`);
                document.getElementById('dmUsername').value = '';
                document.getElementById('dmMessage').value = '';
            }
        }

        async function monitorDMs() {
            const loading = document.getElementById('loading2');
            loading.classList.add('active');
            addLog('üì¨ Monitoring DMs and auto-replying...');
            
            const result = await apiCall('/api/monitor-dms', 'POST');
            
            loading.classList.remove('active');
            if (result.error) {
                addLog('‚ùå Error: ' + result.error);
            } else {
                addLog('‚úÖ ' + result.message);
            }
        }

        async function scrapeFollowers() {
            const targetAccount = document.getElementById('targetAccount').value.trim();
            const maxFollowers = parseInt(document.getElementById('maxFollowers').value);
            
            if (!targetAccount) {
                alert('Please enter a target account');
                return;
            }

            const loading = document.getElementById('loading4');
            loading.classList.add('active');
            addLog(`üë• Scraping followers from @${targetAccount}...`);
            
            const result = await apiCall('/api/scrape-followers', 'POST', { targetAccount, maxFollowers });
            
            loading.classList.remove('active');
            if (result.error) {
                addLog('‚ùå Error: ' + result.error);
            } else {
                addLog(`‚úÖ Scraped ${result.followers?.length || 0} followers`);
            }
        }

        async function checkScheduler() {
            const loading = document.getElementById('loading4');
            loading.classList.add('active');
            addLog('‚è∞ Checking scheduler...');
            
            const result = await apiCall('/api/scheduler/status');
            
            loading.classList.remove('active');
            if (result.error) {
                addLog('‚ùå Error: ' + result.error);
            } else {
                addLog(`‚è∞ Scheduler: ${result.isRunning ? 'Running ‚úÖ' : 'Stopped ‚ùå'}`);
            }
        }

        async function getMyProfile() {
            const loading = document.getElementById('loading4');
            loading.classList.add('active');
            addLog('üë§ Fetching profile...');
            
            const result = await apiCall('/api/me');
            
            loading.classList.remove('active');
            if (result.error) {
                addLog('‚ùå Error: ' + result.error);
            } else {
                addLog(`üë§ Username: ${result.username || 'Unknown'}`);
            }
        }

        let logRefreshInterval = null;
        
        async function loadScreenshots() {
            const gallery = document.getElementById('screenshotGallery');
            gallery.innerHTML = '<p style="text-align: center; color: #667eea;">Loading screenshots...</p>';
            
            const result = await apiCall('/api/screenshots/list');
            
            if (result.error || !result.screenshots) {
                gallery.innerHTML = '<p style="text-align: center; color: #ef4444;">Error loading screenshots</p>';
                return;
            }
            
            if (result.screenshots.length === 0) {
                gallery.innerHTML = '<p style="text-align: center; color: #6b7280;">No screenshots found</p>';
                return;
            }
            
            gallery.innerHTML = '';
            result.screenshots.forEach(screenshot => {
                const item = document.createElement('div');
                item.style.cssText = 'margin-bottom: 15px; padding: 10px; background: #f9fafb; border-radius: 8px; cursor: pointer;';
                item.onclick = () => viewScreenshot(screenshot.type, screenshot.path);
                
                const typeEmoji = screenshot.type === 'post' ? 'üìÑ' : 
                                 screenshot.type === 'profile' ? 'üë§' :
                                 screenshot.type === 'dm' ? 'üí¨' : 'üì∞';
                
                const date = new Date(screenshot.timestamp).toLocaleString();
                
                item.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 24px;">${typeEmoji}</span>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #1f2937;">${screenshot.type.toUpperCase()}</div>
                            <div style="font-size: 12px; color: #6b7280;">${date}</div>
                            <div style="font-size: 11px; color: #9ca3af;">${screenshot.name}</div>
                        </div>
                        <span style="color: #667eea;">üëÅÔ∏è</span>
                    </div>
                `;
                
                gallery.appendChild(item);
            });
            
            addLog(`‚úÖ Loaded ${result.screenshots.length} screenshots`);
        }
        
        function viewScreenshot(type, filename) {
            const url = `${API_URL}/api/screenshots/view/${type}/${filename}`;
            window.open(url, '_blank', 'width=800,height=600');
        }
        
        async function viewLogs() {
            const result = await apiCall('/api/logs/recent?lines=100');
            
            if (result.error) {
                console.error('Error fetching logs:', result.error);
                return;
            }
            
            const logs = document.getElementById('logs');
            const lines = result.logs || [];
            
            // Clear existing logs and add new ones
            logs.innerHTML = '';
            if (lines.length === 0) {
                const entry = document.createElement('div');
                entry.className = 'log-entry';
                entry.textContent = 'No log entries available.';
                logs.appendChild(entry);
            } else {
                // Show newest first (reverse the array)
                lines.reverse().forEach(line => {
                    const entry = document.createElement('div');
                    entry.className = 'log-entry';
                    
                    // Color code based on content
                    if (line.includes('‚úÖ') || line.includes('Successfully')) {
                        entry.classList.add('log-success');
                    } else if (line.includes('‚ùå') || line.includes('error:')) {
                        entry.classList.add('log-error');
                    } else if (line.includes('‚ö†Ô∏è') || line.includes('warn:')) {
                        entry.classList.add('log-warning');
                    } else if (line.includes('info:') || line.includes('üì°')) {
                        entry.classList.add('log-info');
                    }
                    
                    entry.textContent = line;
                    logs.appendChild(entry);
                });
            }
        }
        
        function toggleLiveLog() {
            const btn = document.getElementById('liveLogBtn');
            if (logRefreshInterval) {
                // Stop live refresh
                clearInterval(logRefreshInterval);
                logRefreshInterval = null;
                btn.textContent = '‚ñ∂Ô∏è Start Live Log';
                btn.classList.remove('btn-danger');
                btn.classList.add('btn-success');
                addLog('‚è∏Ô∏è Live log stopped');
            } else {
                // Start live refresh
                viewLogs(); // Fetch immediately
                logRefreshInterval = setInterval(viewLogs, 3000); // Refresh every 3 seconds
                btn.textContent = '‚è∏Ô∏è Stop Live Log';
                btn.classList.remove('btn-success');
                btn.classList.add('btn-danger');
                addLog('‚ñ∂Ô∏è Live log started (updates every 3s)');
            }
        }

        // Auto-refresh status every 30 seconds
        setInterval(checkStatus, 30000);

        // Initialize on load
        window.onload = () => {
            checkStatus();
            updateInteractionFields();
            
            // Auto-fill username if saved
            const savedUsername = localStorage.getItem('savedUsername');
            if (savedUsername) {
                document.getElementById('loginUsername').value = savedUsername;
            }
            
            addLog('ü§ñ Dashboard loaded - Marketing Team App');
            addLog('üí° Ready to generate leads!');
        };
    </script>
</body>
</html>
